{
  "updatedAt": "2026-01-24T04:01:57.953Z",
  "createdAt": "2025-12-20T02:14:15.837Z",
  "id": "4cCsYYYaNoTNWB3U",
  "name": "Board_Deck_Takeaways",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {},
      "id": "trigger1",
      "name": "When clicking 'Execute workflow'",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        224,
        1120
      ],
      "disabled": true
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"dashboard_discovery_model_version\": \"1.0\",\n  \"snowflake_base_url\": \"https://ml16699-hya89079.snowflakecomputing.com\",\n  \"omni_documents_search_service\": {\n    \"snowflake_database\": \"ANALYTICS\",\n    \"snowflake_schema\": \"OMNI\",\n    \"service_name\": \"omni_documents_search_service\"\n  },\n  \"omni_api\": {\n    \"omni_base_url\": \"https://cribl.omniapp.co\",\n    \"model_id\": \"4345b118-cbbe-4f7c-a705-ea0aa8da57c0\"\n  },\n  \"snowflake_tables\": {\n    \"omni_documents\": {\n      \"snowflake_database\": \"ANALYTICS\",\n      \"snowflake_schema\": \"OMNI\",\n      \"table_name\": \"DOCUMENTS\"\n    },\n    \"dashboard_recommendations\": {\n      \"snowflake_database\": \"RAW\",\n      \"snowflake_schema\": \"OMNI\",\n      \"table_name\": \"DASHBOARD_RECOMMENDATIONS\"\n    }\n  },\n  \"default_user_id\": \"893ce348-0fb2-44ac-b0f8-06521a341580\"\n}",
        "includeOtherFields": true,
        "include": "except",
        "excludeFields": "headers,params,query,webhookUrl,executionMode",
        "options": {}
      },
      "id": "globalVars1",
      "name": "Global Vars",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        832,
        1120
      ]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"c3023df3-39f1-4913-86c8-07d69f6caeb1\": [\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_customers\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.customer_type\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\",\n          \"finance__customer_quarterly_arr.total_churn_arr\",\n          \"finance__customer_quarterly_arr.total_downsell_arr\",\n          \"finance__customer_quarterly_arr.total_ending_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    \\\"CUSTOMER_TYPE\\\" AS \\\"finance__customer_quarterly_arr.customer_type\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"CHURN_ARR\\\" < 0 THEN \\\"CHURN_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_churn_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"DOWNSELL_ARR\\\" < 0 THEN \\\"DOWNSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_downsell_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"ENDING_ARR\\\" > 0 THEN \\\"ENDING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_ending_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 5, 3, 1\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_migration_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.customer_type\",\n          \"finance__customer_quarterly_arr.total_migration_arr\",\n          \"finance__customer_quarterly_arr.migration_arr_cloud\",\n          \"finance__customer_quarterly_arr.migration_arr_software\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"df073f20-17b0-4d9c-b667-2b2f86b5fae8\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    \\\"CUSTOMER_TYPE\\\" AS \\\"finance__customer_quarterly_arr.customer_type\\\",\\n    COALESCE(SUM(\\\"MIGRATION_ARR_CLOUD\\\"), 0) AS \\\"finance__customer_quarterly_arr.total_migration_arr\\\",\\n    \\\"MIGRATION_ARR_CLOUD\\\" AS \\\"finance__customer_quarterly_arr.migration_arr_cloud\\\",\\n    \\\"MIGRATION_ARR_SOFTWARE\\\" AS \\\"finance__customer_quarterly_arr.migration_arr_software\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 5, 3, 1, 7, 8\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_gross_new_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [\n          {\n            \"column_name\": \"finance__customer_quarterly_arr.total_starting_arr\",\n            \"sort_descending\": true\n          }\n        ],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"51b818b3-a897-4ede-a516-ab7436c6be97\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 3, 1\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_gross_new_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [\n          {\n            \"column_name\": \"finance__customer_quarterly_arr.total_new_arr\",\n            \"sort_descending\": true\n          }\n        ],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"51b818b3-a897-4ede-a516-ab7436c6be97\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 3, 1\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_gross_new_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [\n          {\n            \"column_name\": \"finance__customer_quarterly_arr.total_upsell_arr\",\n            \"sort_descending\": true\n          }\n        ],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"51b818b3-a897-4ede-a516-ab7436c6be97\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 3, 1\\nLIMIT 1000\"\n    }\n  ]\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "id": "loadQueries1",
      "name": "Load Drill Queries",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2064,
        1120
      ]
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "outerLoop1",
      "name": "Loop Over UUIDs",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3152,
        1120
      ],
      "executeOnce": false
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "innerLoop1",
      "name": "Loop Over Queries",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4432,
        1456
      ],
      "executeOnce": false
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n-relayer-1.app.n8n.cloud/webhook/omni-pattern-detection-subworkflow",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "callbackurl",
              "value": "={{ $execution.resumeUrl }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ \n\n  $json\n}}",
        "options": {}
      },
      "id": "httpPost1",
      "name": "POST Drill Query",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5808,
        1456
      ],
      "executeOnce": false,
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const inputData = $('Load Drill Queries').first().json;\n  const systemFields = ['headers', 'params', 'query', 'webhookUrl', 'executionMode'];\n  const drillQueries = {};\n\n  for (const [key, value] of Object.entries(inputData)) {\n    if (!systemFields.includes(key) && typeof value === 'object' && Array.isArray(value)) {\n      drillQueries[key] = value;\n    }\n  }\n\n  const uuidKeys = Object.keys(drillQueries);\n\n  if (uuidKeys.length === 0) {\n    return [{\n      json: {\n        error: 'No drill query UUIDs found in input data',\n        inputKeys: Object.keys(inputData)\n      }\n    }];\n  }\n\n  let drill_queries = uuidKeys.map(document_query_id => ({\n    json: {\n      document_query_id: document_query_id,\n      document_query_name: drillQueries[document_query_id][0][\"document_query_name\"],\n      queries: drillQueries[document_query_id],\n      queryCount: drillQueries[document_query_id].length\n    }\n  }))\n\n  return drill_queries;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2656,
        1120
      ],
      "id": "d9071922-dd3c-4544-8313-87cd21b0b593",
      "name": "Prepare UUID Loop Data"
    },
    {
      "parameters": {
        "jsCode": "console.log($(\"Loop UUID Item\").item.json);\n\nconst currentItem = $(\"Loop UUID Item\").item.json;\n\n\nif (!currentItem.document_query_id || !currentItem.queries) {\n  return [{\n    json: {\n      error: 'Missing required fields: document_query_id or queries',\n      received: currentItem\n    }\n  }];\n}\n\nconst document_query_id = currentItem.document_query_id;\nconst queries = currentItem.queries;\n\nif (!Array.isArray(queries)) {\n  return [{\n    json: {\n      error: 'queries is not an array',\n      type: typeof queries\n    }\n  }];\n}\n\nreturn queries.map(query => ({\n  json: {\n    document_query_id: document_query_id,\n    document_query_name: query.document_query_name || '',\n    drill_name: query.drill_name || 'unnamed_drill',\n    query: query.query || {}\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4112,
        1280
      ],
      "id": "5dfd4e0b-b9ab-4a4d-a846-c8ef49e931bd",
      "name": "Extract Queries for UUID"
    },
    {
      "parameters": {
        "resume": "webhook",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "314fa1dd-a8d8-4354-80ef-da7b8dfbcc74",
      "name": "Webhook Callback Wait",
      "type": "n8n-nodes-base.wait",
      "position": [
        6672,
        672
      ],
      "webhookId": "5cd058b4-48c8-449a-9c09-959a5b8a2b48",
      "typeVersion": 1.1,
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "let json = $('If All Finished').first().json;\nif (!json.finishedSet) json.finishedSet = [];\nlet finishedItemId = $('Webhook Callback Wait').item.json.body.finishedItemId;\nif (!json.finishedSet[finishedItemId]) json.finishedSet.push(finishedItemId);\nreturn [json];"
      },
      "id": "3c2603e2-8aee-4535-9439-66fe53a931d0",
      "name": "Update finishedSet",
      "type": "n8n-nodes-base.code",
      "position": [
        7312,
        672
      ],
      "typeVersion": 2,
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "193ab8f1-0e23-491c-914e-b8b26b0160f7",
              "name": "finishedSet",
              "type": "array",
              "value": "[]"
            }
          ]
        },
        "options": {}
      },
      "id": "5ae9644b-a5ee-4306-a28b-c7ae6611c0c7",
      "name": "Initialize finishedSet",
      "type": "n8n-nodes-base.set",
      "position": [
        4176,
        512
      ],
      "executeOnce": true,
      "typeVersion": 3.4,
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 1,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "385c3149-3623-4dd2-9022-770c32f82421",
              "operator": {
                "type": "number",
                "operation": "gte"
              },
              "leftValue": "={{ $json.finishedSet.length }}",
              "rightValue": "={{ $('Get Drill Queries Count').first().json.drill_queries_count }}"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e9a9ea4a-2ef4-4f05-b2b6-c52a1814512c",
      "name": "If All Finished",
      "type": "n8n-nodes-base.if",
      "position": [
        5584,
        512
      ],
      "typeVersion": 2,
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "9e8c5598-babe-4684-8f76-744f71d8831c",
      "name": "Acknowledge Finished",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        7152,
        896
      ],
      "typeVersion": 1.1,
      "disabled": true
    },
    {
      "parameters": {
        "content": "### Pseudo-Synchronously Wait for All Sub-Workflows to finish",
        "height": 80,
        "width": 283,
        "color": 3
      },
      "id": "3fc5a382-5cdd-4559-bdd3-b37073d26d50",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3440,
        592
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {},
      "id": "0f6a8b67-bd1b-40bc-80d5-b7378ce5b57c",
      "name": "Continue Workflow (noop)",
      "type": "n8n-nodes-base.noOp",
      "position": [
        7040,
        352
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const inputData = $('Load Drill Queries').first().json;\n  const systemFields = ['headers', 'params', 'query', 'webhookUrl', 'executionMode'];\n  const drillQueries = {};\n\n  for (const [key, value] of Object.entries(inputData)) {\n    if (!systemFields.includes(key) && typeof value === 'object' && Array.isArray(value)) {\n      drillQueries[key] = value;\n    }\n  }\n\n  const uuidKeys = Object.keys(drillQueries);\n\n  if (uuidKeys.length === 0) {\n    return [{\n      json: {\n        error: 'No drill query UUIDs found in input data',\n        inputKeys: Object.keys(inputData)\n      }\n    }];\n  }\n\n  let count = 0;\n  uuidKeys.forEach(uuid => count += drillQueries[uuid].length);\n\n  return {\n    \"drill_queries_count\": count\n  };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        1120
      ],
      "id": "347e89ad-1d53-4099-8d9d-20a8602b2c12",
      "name": "Get Drill Queries Count"
    },
    {
      "parameters": {
        "amount": 0.4
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7168,
        1760
      ],
      "id": "75631430-add9-4385-b26e-6c83f12f04e6",
      "name": "Wait",
      "webhookId": "722519d8-a165-4f2b-a0fc-24915e959db5",
      "disabled": true
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"today\": \"2026-02-22\",\n  \"current_fiscal_quarter\": \"FY2027 Q1\",\n  \"previous_fiscal_quarter\": \"FY2026 Q4\",\n  \"current_fiscal_half\": \"FY2027 H1\",\n  \"previous_fiscal_half\": \"FY2026 H2\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1296,
        1328
      ],
      "id": "0f55f706-a159-4c68-bb74-68f7dbe15efe",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<role>\nYou are a date-aware automation agent that, at runtime, uses the current calendar date and converts it into the organization’s fiscal quarter and fiscal half-year.\n</role>\n\n<task>\n1. Capture today’s date in ISO-8601 format (YYYY-MM-DD).  \n2. Derive the current fiscal quarter using this mapping:  \n   • February, March, April → Q1  \n   • May, June, July → Q2  \n   • August, September, October → Q3  \n   • November, December, January → Q4\n3. Similarly, derive the previous fiscal quarter.\n4. Then, derive the previous' previous fiscal quarter. In the end, you will have 3 fiscal quarters. From here on out, you will consider the \"current_fiscal_quarter\" to be your derived previous fiscal quarter and you will consider the \"previous_fiscal_quarter\" to be your derived 2 quarters previous. This is because we will run this at the end of each quarter that has just finished in order to compare this most recently finished fiscal quarter with 2 quarters ago.\n4. Determine the current fiscal half-year: \n   • H1 = Q1 + Q2 (February – July) \n   • H2 = Q3 + Q4 (August – January)\n5. Similarly to deriving the current fiscal half-year, derive the previous fiscal half-year\n6. Assign the fiscal year (FY):  \n   • FY is labelled by the calendar year of the January that closes Q4.  \n     – Example: any date from 2025-11-01 through 2026-01-31 belongs to FY2026 Q4.  \n7. If a month is ever missing from the mapping (unexpected), set  \n   \"fiscal_quarter\": \"Unmapped\", \"fiscal_half\": \"Unmapped\",  \n   add a \"warning\" key explaining why, and continue.  \n8. Produce one JSON object that follows the output_format section exactly.  \n9. Self-check: validate JSON syntax, confirm quarter/half/year logic, and flag any ambiguity or edge case before returning.\n</task>\n\n<context>\nThe organization follows a non-standard fiscal calendar that begins in February and spans ten active months, grouping them into the quarters above.  \nWe prefer the simplest workflow that fully handles edge cases (e.g., leap years, timezone differences, cross-year FY labelling) and follows security-best practices.\n</context>\n\n<examples>\n<fiscal_quarter_examples>\n2024-02-01 → FY2025 Q1  \n2024-05-15 → FY2025 Q2\n2024-07-29 → FY2025 Q2\n2024-08-01 → FY2025 Q3\n2024-10-30 → FY2025 Q3\n2024-12-30 → FY2025 Q4  \n2025-01-31 → FY2025 Q4\n2025-02-01 → FY2026 Q1\n2025-06-10 → FY2026 Q2  \n2025-09-05 → FY2026 Q3  \n2025-12-12 → FY2026 Q4  \n2026-03-03 → FY2027 Q1\n2026-05-22 → FY2027 Q2\n</fiscal_quarter_examples>\n\n<fiscal_half_examples>\n2024-02-01 → FY2025 H1\n2024-05-15 → FY2025 H1\n2024-07-29 → FY2025 H1\n2024-08-01 → FY2025 H2\n2024-10-30 → FY2025 H2\n2024-12-30 → FY2025 H2  \n2025-01-31 → FY2025 H2  \n2025-02-01 → FY2026 H1\n2025-06-10 → FY2026 H1  \n2025-09-05 → FY2026 H2  \n2025-12-12 → FY2026 H2  \n2026-03-03 → FY2027 H1\n2026-05-22 → FY2027 H1\n</fiscal_half_examples>\n\n</examples>\n\n<guidelines>\n- Output only the JSON object—no extra text.  \n- Keys must be lower_snake_case and wrapped in double quotes.  \n- Do not include trailing commas.  \n- Point out any implicit or non-obvious “gotchas” (e.g., FY roll-over rules) in the \"warning\" field instead of silently proceeding.  \n- Do not simply agree; highlight anything incorrect or sub-optimal and suggest improvements.  \n- Think step-by-step, then self-check that the response meets every instruction before returning it.\n</guidelines>\n\n<input>\ntoday: {{ $today.format('yyyy-MM-dd') }}\n</input>\n\n<output_format>\n{\n  \"today\": \"2026-05-22\",\n  \"current_fiscal_quarter\": \"FY2027 Q1\",\n  \"previous_fiscal_quarter\": \"FY2026 Q4\",\n  \"current_fiscal_half\": \"FY2027 H1\",\n  \"previous_fiscal_half\": \"FY2026 H2\"\n}\n</output_format>",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1136,
        1120
      ],
      "id": "627f6fd7-713f-44fe-8a43-511b655cf548",
      "name": "Fiscal Quarter Extractor"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\t\"current_fiscal_quarter_query\": {\n  \n},\n\t\"previous_fiscal_quarter_query\": {\n  \n}\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        4096,
        2656
      ],
      "id": "5d7f57ba-6e3f-488c-aaac-d6db6eca7df4",
      "name": "Structured Output Parser1",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  let output = JSON.parse(item.json.output);\n\n  if (\"current_fiscal_quarter_query\" in output) {\n    item.json.current_fiscal_quarter_query = output.current_fiscal_quarter_query;\n  }\n\n  if (\"previous_fiscal_quarter_query\" in output) {\n    item.json.previous_fiscal_quarter_query = output.previous_fiscal_quarter_query;\n  }\n  \n  if (\"query\" in output) {\n    item.json.query = output.query;\n  }\n\n  delete item.json.output;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4512,
        2448
      ],
      "id": "39eee60c-2b5f-4c2c-8082-d9b95868ed89",
      "name": "Parse Modified Query AI Output",
      "disabled": true
    },
    {
      "parameters": {
        "model": "o4-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
      "typeVersion": 1,
      "position": [
        1120,
        1328
      ],
      "id": "5421085b-5efc-40de-895d-5f9d003d2ddf",
      "name": "o4-mini",
      "credentials": {
        "azureOpenAiApi": {
          "id": "N96DE6AiByL8h8kA",
          "name": "Azure OpenAI o4-mini"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"document_query_id\": \"{{ $('Loop Query Item').item.json.document_query_id }}\",\n  \"document_query_name\": \"{{ $('Loop Query Item').item.json.document_query_name }}\",\n  \"drill_name\": \"{{ $('Loop Over Queries').item.json.drill_name }}\",\n  \"current_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').first().json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').first().json.output.previous_fiscal_quarter }}\",\n  \"current_fiscal_half\": \"{{ $('Fiscal Quarter Extractor').first().json.output.current_fiscal_half }}\",\n  \"previous_fiscal_half\": \"{{ $('Fiscal Quarter Extractor').first().json.output.previous_fiscal_half }}\",\n  \"user_id\": \"{{ $('Global Vars').first().json.default_user_id }}\",\n  \"current_fiscal_quarter_query\": {{ $('Parse Modified Query AI Output1').item.json.current_fiscal_quarter_query || {} }},\n  \"previous_fiscal_quarter_query\": {{ $('Parse Modified Query AI Output1').item.json.previous_fiscal_quarter_query || {} }},\n  \"google_document_id\": \"{{ $('Create Takeaways Doc').item.json.id }}\"\n\n}\n\n\n\n",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6016,
        1696
      ],
      "id": "b62a9170-658d-4907-9592-d33d8e748f5a",
      "name": "Create Request Payload"
    },
    {
      "parameters": {
        "content": "<role>\nYou are a JSON-transformation agent who edits BI-tool query objects for fiscal quarter comparisons with automatic sorting.\n</role>\n\n<task>\nGoal: Produce two modified copies of the supplied query JSON with numeric measure sorts added and fiscal quarter filters updated.\n\nPlan of action (follow sequentially):\n1. Parse the input JSON exactly as received; preserve every field order and value.\n2. **Add Sorts**: Identify numeric measures in the \"fields\" array and add them to the \"sorts\" array.\n3. **Locate Filter**: Find the first object inside \"filters\" whose inner field \"kind\" equals \"TIME_FOR_UNIT_DURATION\" (case-sensitive).\n4. **Duplicate Query**: Create two copies of the modified query:\n   a. In Copy 1, replace that filter object's \"left_side\" value with the provided {current_fiscal_quarter}.\n   b. In Copy 1, replace the numeric value in \"limit\" to 200.\n   c. In Copy 2, replace that same \"left_side\" value with the provided {previous_fiscal_quarter}.\n   d. In Copy 2, replace the numeric value in \"limit\" to 200.\n5. **Return**: A JSON object with the structured output format containing the two edited query objects for keys: current_fiscal_quarter_query and previous_fiscal_quarter_query.\n</task>\n\n<context>\nYou will receive:\n• A complete JSON object named \"query\" following Omni analytics query structure\n• Two strings:\n  – current_fiscal_quarter\n  – previous_fiscal_quarter\n\nThe query object contains these key fields:\n- **fields**: Array of column names to SELECT and display (format: \"schema__table.field_name\")\n- **sorts**: Array of sort configuration objects (you will modify this)\n- **filters**: Object containing WHERE clause conditions\n- **limit**: Numeric value for row limit (you will set this to 200)\n- **table**: String reference to the data table\n- **modelId**: Omni model identifier (UUID)\n- **version**: Query schema version\n- **Other fields**: pivots, calculations, etc. (preserve unchanged)\n\nModify **ONLY** the \"sorts\" array, the \"left_side\" value of the TIME_FOR_UNIT_DURATION filter, and the \"limit\" value. All other content must remain bit-for-bit identical, including whitespace and ordering. We prefer the simplest workflow that fully handles edge cases and follows security-best practices.\n</context>\n\n<numeric_measure_identification>\n<step_1>\n<description>\nIdentify Numeric Measures in Fields Array\n\nScan the \"fields\" array and identify numeric measures using these patterns:\n</description>\n\n<inclusion_patterns>\nInclusion Patterns (these ARE numeric measures):\n- `total_*` → e.g., total_ending_arr, total_customers, total_new_arr\n- `*_arr` → e.g., new_arr, upsell_arr, churn_arr, downsell_arr\n- `*_sum` → e.g., revenue_sum, new_arr_sum\n- `*_count` → e.g., opportunity_count, customer_count\n- `*_max`, `*_min` → e.g., lake_gbs_customer_data_max, min_date\n- `*_avg`, `*_average`, `*_mean` → e.g., avg_deal_size, mean_time_to_close\n- `*_gb`, `*_tb`, `*_bytes` → e.g., total_cloud_stream_in_gb_30d, total_edge_in_bytes\n- `*_nodes`, `*_instances` → e.g., total_edge_nodes, cloud_edge_nodes_30d\n- `*_percentage`, `*_percent`, `*_rate`, `*_ratio` → percentage/ratio metrics\n- `*_revenue`, `*_bookings`, `*_billings` → financial metrics\n- `*_headcount`, `*_employees`, `*_users` → when aggregated\n- `*_derived` → e.g., new_arr_derived, calculated_revenue_derived\n- `cumulative_*` → e.g., cumulative_revenue\n- `max_*`, `min_*` → e.g., max_edge_nodes, min_starting_arr\n</inclusion_patterns>\n\n<exclusion_patterns>\nExclusion Patterns (these are NOT numeric measures - they're dimensions):\n- `*_name`, `*_title` → e.g., customer_name, account_name, owner_name\n- `*_id` → e.g., cribl_id, org_id, opportunity_id (identifiers are dimensions)\n- `*_date`, `*_time`, `*_timestamp` → e.g., close_date, created_at\n- `*_type`, `*_category`, `*_status` → e.g., customer_type, stage_name\n- `*_description`, `*_notes` → text descriptions\n- `is_*`, `has_*` → e.g., is_last_day_of_fq, is_active (boolean flags)\n- Fields with `[transformations]` → e.g., fiscal_quarter[fiscal_quarter], first_purchase_quarter[date]\n- `owner_*`, `created_by_*`, `updated_by_*` → user references\n- `*_key` → lookup keys\n</exclusion_patterns>\n\n<pattern_matching_rules>\nPattern Matching Rules (Regex):\n```\nINCLUDE if field name matches ANY of:\n  - ^.*total_.*$              (contains \"total_\")\n  - ^.*_arr$                  (ends with \"_arr\")\n  - ^.*_sum$                  (ends with \"_sum\")\n  - ^.*_count$                (ends with \"_count\")\n  - ^.*_max$                  (ends with \"_max\")\n  - ^.*_min$                  (ends with \"_min\")\n  - ^.*_avg$|^.*_mean$        (ends with \"_avg\" or \"_mean\")\n  - ^.*_gb.*$|^.*_bytes.*$    (contains \"_gb\" or \"_bytes\")\n  - ^.*_nodes.*$              (contains \"_nodes\")\n  - ^.*_derived$              (ends with \"_derived\")\n  - ^max_.*$|^min_.*$         (starts with \"max_\" or \"min_\")\n  - ^cumulative_.*$           (starts with \"cumulative_\")\n\nEXCLUDE if field name matches ANY of:\n  - ^.*_name$|^.*_title$      (ends with \"_name\" or \"_title\")\n  - ^.*_id$                   (ends with \"_id\")\n  - ^.*date.*$|^.*quarter.*$  (contains \"date\" or \"quarter\")\n  - ^.*_at$                   (ends with \"_at\")\n  - ^.*_type$|^.*_status$     (ends with \"_type\" or \"_status\")\n  - ^.*_stage$                (ends with \"_stage\")\n  - ^is_.*$|^has_.*$          (starts with \"is_\" or \"has_\")\n  - ^.*\\[.*\\]$                (contains brackets)\n```\n</pattern_matching_rules>\n\n<example_field_analysis>\nExample Field Analysis:\n- `finance__customer_quarterly_arr.total_customers` → ✅ NUMERIC MEASURE (matches `total_*`)\n- `finance__customer_quarterly_arr.customer_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.total_arr` → ✅ NUMERIC MEASURE (matches `total_*` and `*_arr`)\n- `finance__customer_quarterly_arr.fiscal_quarter_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.new_arr_sum` → ✅ NUMERIC MEASURE (matches `*_sum`)\n- `finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]` → ❌ DIMENSION (has brackets)\n</example_field_analysis>\n</step_1>\n</numeric_measure_identification>\n\n<sort_object_creation>\n<step_2>\n<description>\nCreate Sort Objects for Numeric Measures\n\nFor each identified numeric measure, create a sort object with this structure:\n\n```json\n{\n  \"column_name\": \"schema__table.field_name\",\n  \"sort_descending\": true\n}\n```\n</description>\n\n<field_definitions>\nField Definitions:\n- **column_name** (required, string): The exact field reference from the fields array\n- **sort_descending** (required, boolean): Set to `true` for descending sort (largest values first)\n</field_definitions>\n\n<sort_direction_guidelines>\nSort Direction Guidelines:\n- Numeric measures: Use `true` (descending) to show largest values first\n- This is the standard for BI tools to show \"top performers\" or \"highest values\"\n</sort_direction_guidelines>\n\n<deduplication>\nDeduplication:\nIf the \"sorts\" array already has items, check before adding:\n- If a sort object already exists for a given `column_name`, skip it\n- Append new sort objects only for measures not already in sorts\n- Preserve existing sort objects in their original order\n</deduplication>\n\n<example>\nExample:\nInput fields:\n```json\n[\n  \"finance__customer_quarterly_arr.customer_name\",\n  \"finance__customer_quarterly_arr.total_ending_arr\",\n  \"finance__customer_quarterly_arr.total_new_arr\"\n]\n```\n\nCreated sort objects:\n```json\n[\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_ending_arr\",\n    \"sort_descending\": true\n  },\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_new_arr\",\n    \"sort_descending\": true\n  }\n]\n```\n\nNote: `customer_name` is excluded because it ends with `_name` (dimension, not measure).\n</example>\n</step_2>\n</sort_object_creation>\n\n<query_modification>\n<step_3>\n<description>\nModify Query Object - Add Sorts\n\nAdd the created sort objects to the \"sorts\" array in the query object.\n</description>\n\n<before_adding_sorts>\nBefore Adding Sorts:\n```json\n{\n  \"sorts\": [],\n  \"fields\": [\n    \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n    \"finance__customer_quarterly_arr.total_customers\",\n    \"finance__customer_quarterly_arr.total_arr\"\n  ]\n}\n```\n</before_adding_sorts>\n\n<after_adding_sorts>\nAfter Adding Sorts:\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n      \"sort_descending\": true\n    },\n    {\n      \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n      \"sort_descending\": true\n    }\n  ],\n  \"fields\": [\n    \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n    \"finance__customer_quarterly_arr.total_customers\",\n    \"finance__customer_quarterly_arr.total_arr\"\n  ]\n}\n```\n</after_adding_sorts>\n</step_3>\n</query_modification>\n\n<fiscal_quarter_modification>\n<step_4>\n<description>\nModify Fiscal Quarter Filter and Limit\n\nAfter adding sorts, locate and modify the TIME_FOR_UNIT_DURATION filter:\n\n1. Find the first filter object where `\"kind\": \"TIME_FOR_UNIT_DURATION\"`\n2. Note the current \"left_side\" value\n3. Prepare to create two copies with different left_side values\n</description>\n\n<filter_structure>\nFilter Structure:\n```json\n{\n  \"type\": \"date\",\n  \"kind\": \"TIME_FOR_UNIT_DURATION\",\n  \"left_side\": \"FY2026 Q1\",\n  \"right_side\": {\n    \"unit\": \"fiscal_quarter\",\n    \"count\": 1\n  }\n}\n```\n</filter_structure>\n\n<modifications_for_each_copy>\nModifications for Each Copy:\n- **Copy 1 (current_fiscal_quarter_query)**:\n  - Set `left_side` to {current_fiscal_quarter}\n  - Set `limit` to 200\n- **Copy 2 (previous_fiscal_quarter_query)**:\n  - Set `left_side` to {previous_fiscal_quarter}\n  - Set `limit` to 200\n</modifications_for_each_copy>\n</step_4>\n</fiscal_quarter_modification>\n\n<examples>\n<complete_example>\n<input>\n```json\n{\n  \"query\": {\n    \"limit\": 1000,\n    \"sorts\": [],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q1\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  },\n  \"current_fiscal_quarter\": \"FY2026 Q2\",\n  \"previous_fiscal_quarter\": \"FY2026 Q1\"\n}\n```\n</input>\n\n<processing_steps>\nProcessing Steps:\n\n**Step 1: Identify numeric measures**\n- ❌ `fiscal_quarter_name` → ends with `_name` (dimension)\n- ✅ `total_customers` → matches `total_*` (measure)\n- ✅ `total_arr` → matches `total_*` and `*_arr` (measure)\n\n**Step 2: Create sort objects**\n```json\n[\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n    \"sort_descending\": true\n  },\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n    \"sort_descending\": true\n  }\n]\n```\n\n**Step 3: Add sorts to query**\n\n**Step 4: Find TIME_FOR_UNIT_DURATION filter and prepare for duplication**\n\n**Step 5: Create two copies with modified values**\n</processing_steps>\n\n<expected_output>\n```json\n{\n  \"current_fiscal_quarter_query\": {\n    \"limit\": 200,\n    \"sorts\": [\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n        \"sort_descending\": true\n      },\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n        \"sort_descending\": true\n      }\n    ],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q2\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  },\n  \"previous_fiscal_quarter_query\": {\n    \"limit\": 200,\n    \"sorts\": [\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n        \"sort_descending\": true\n      },\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n        \"sort_descending\": true\n      }\n    ],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q1\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  }\n}\n```\n</expected_output>\n</complete_example>\n</examples>\n\n<input>\n{\n  \"query\": {{ $json.query.toJsonString() }},\n  \"current_fiscal_quarter\": \"{{  $('Fiscal Quarter Extractor').item.json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').item.json.output.previous_fiscal_quarter }}\"\n}\n</input>\n\n<edge_cases>\n<description>\nEdge Cases to Handle\n</description>\n\n<case_1>\n1. Query with existing sorts:\n- Append new sort objects to the existing sorts array\n- Preserve the order of existing sorts\n- Do not create duplicate sort objects for fields already in sorts\n\n**Example Input:**\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"sales__opportunity.new_arr_derived\",\n      \"sort_descending\": true\n    }\n  ],\n  \"fields\": [\n    \"sales__opportunity.account_name\",\n    \"sales__opportunity.new_arr_derived\",\n    \"sales__opportunity.total_arr\"\n  ]\n}\n```\n\n**Processing:**\n- `new_arr_derived` already has a sort → skip\n- `total_arr` does not have a sort → add\n\n**Result:**\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"sales__opportunity.new_arr_derived\",\n      \"sort_descending\": true\n    },\n    {\n      \"column_name\": \"sales__opportunity.total_arr\",\n      \"sort_descending\": true\n    }\n  ]\n}\n```\n</case_1>\n\n<case_2>\n2. Query with no numeric measures:\n- Return the query with only fiscal quarter and limit modifications\n- The sorts array remains as-is (empty or with existing sorts)\n\n**Example:**\n```json\n{\n  \"fields\": [\n    \"sales__accounts.account_name\",\n    \"sales__accounts.owner_name\",\n    \"sales__opportunity.close_date\"\n  ],\n  \"sorts\": []\n}\n```\n\n**Result:** Sorts array stays empty `[]`\n</case_2>\n\n<case_3>\n3. Query with mixed numeric and dimension fields:\n- Only add sorts for true numeric measures\n- Skip all dimension fields even if they contain numbers in their values\n</case_3>\n\n<case_4>\n4. Multiple TIME_FOR_UNIT_DURATION filters:\n- Only modify the FIRST occurrence\n- Leave other TIME_* filters unchanged\n</case_4>\n\n<case_5>\n5. Missing TIME_FOR_UNIT_DURATION filter:\n- Return error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n</case_5>\n\n<case_6>\n6. Malformed JSON:\n- Return error object: `{\"error\": \"Invalid JSON structure\", \"details\": \"<specific issue>\"}`\n</case_6>\n</edge_cases>\n\n<guidelines>\n<description>\nProcessing Guidelines\n</description>\n\n- Preserve JSON formatting exactly; do not pretty-print or minify.\n- Apply sorts modification BEFORE duplicating the query.\n- Do not alter any filters except the first TIME_FOR_UNIT_DURATION filter's left_side value.\n- If no matching TIME_FOR_UNIT_DURATION filter exists, return an error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n- Point out any ambiguities or missing data instead of guessing.\n- Do not simply agree with assumptions; highlight logical or data issues and propose corrections.\n- Mention tricky edge cases when they occur.\n- Output only valid JSON or an error object - no commentary, preamble, or markdown formatting.\n- Ensure both output queries have identical sorts arrays (derived from the original query's fields).\n- Set limit to exactly 200 in both output queries.\n- Both queries should be complete, valid Omni query objects.\n</guidelines>\n\n<output_format>\n<description>\nExpected Output Structure\n</description>\n\n```json\n{\n  \"current_fiscal_quarter_query\": {\n    /* Complete query object with:\n       - sorts: array with numeric measure sorts\n       - limit: 200\n       - filters: TIME_FOR_UNIT_DURATION.left_side = current_fiscal_quarter\n       - all other fields: unchanged\n    */\n  },\n  \"previous_fiscal_quarter_query\": {\n    /* Complete query object with:\n       - sorts: array with numeric measure sorts (same as current)\n       - limit: 200\n       - filters: TIME_FOR_UNIT_DURATION.left_side = previous_fiscal_quarter\n       - all other fields: unchanged\n    */\n  }\n}\n```\n\nIf there's an error:\n```json\n{\n  \"error\": \"Error description\",\n  \"details\": \"Specific issue details\"\n}\n```\n</output_format>\n\n<validation_checklist>\n<description>\nValidation Before Returning\n\nVerify the following before returning the result:\n</description>\n\n- [ ] All numeric measures from \"fields\" are in \"sorts\" (no duplicates)\n- [ ] No dimension fields (names, IDs, dates) are in \"sorts\"\n- [ ] All sort objects have both \"column_name\" and \"sort_descending\" fields\n- [ ] All \"sort_descending\" values are `true`\n- [ ] Both queries have \"limit\" set to 200\n- [ ] Current query has correct current_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Previous query has correct previous_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Both queries have identical \"sorts\" arrays\n- [ ] All other fields (table, modelId, version, etc.) are preserved unchanged\n- [ ] The output is valid JSON with no syntax errors\n- [ ] Output contains exactly two keys: \"current_fiscal_quarter_query\" and \"previous_fiscal_quarter_query\"\n</validation_checklist>\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5104,
        1296
      ],
      "typeVersion": 1,
      "id": "7ef40ecd-556e-48e1-addd-d5b437cee372",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n    \"type\": \"object\",\n    \"properties\": {\n      \"limit\": {\n        \"type\": \"number\",\n        \"description\": \"Maximum number of rows to return\"\n      },\n      \"sorts\": {\n        \"type\": \"array\",\n        \"description\": \"Array of sort configuration objects\",\n        \"items\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"column_name\": {\n              \"type\": \"string\",\n              \"description\": \"Full field name to sort by (must exist in fields array)\"\n            },\n            \"sort_descending\": {\n              \"type\": \"boolean\",\n              \"description\": \"true for descending (highest first), false for ascending\"\n            },\n            \"null_sort\": {\n              \"type\": \"string\",\n              \"description\": \"Optional: How to handle NULL values (OMNI_DEFAULT, NULLS_FIRST, NULLS_LAST)\",\n              \"enum\": [\"OMNI_DEFAULT\", \"NULLS_FIRST\", \"NULLS_LAST\"]\n            },\n            \"is_column_sort\": {\n              \"type\": \"boolean\",\n              \"description\": \"Optional: Whether this is a column-based sort vs aggregation sort\"\n            }\n          },\n          \"required\": [\"column_name\", \"sort_descending\"]\n        }\n      },\n      \"table\": {\n        \"type\": \"string\",\n        \"description\": \"The primary table/view to query (format: schema__table)\"\n      },\n      \"fields\": {\n        \"type\": \"array\",\n        \"description\": \"List of column names to SELECT\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      },\n      \"pivots\": {\n        \"type\": \"array\",\n        \"description\": \"Pivot table configuration\"\n      },\n      \"dbtMode\": {\n        \"type\": \"boolean\",\n        \"description\": \"Whether to use dbt model directly\"\n      },\n      \"filters\": {\n        \"type\": \"object\",\n        \"description\": \"WHERE clause conditions\"\n      },\n      \"modelId\": {\n        \"type\": \"string\",\n        \"description\": \"Omni model identifier (UUID format)\"\n      },\n      \"version\": {\n        \"type\": \"number\",\n        \"description\": \"Query schema version\"\n      },\n      \"controls\": {\n        \"type\": \"array\",\n        \"description\": \"Dashboard filter controls\"\n      },\n      \"rewriteSql\": {\n        \"type\": \"boolean\",\n        \"description\": \"Allow SQL rewriting for optimization\"\n      },\n      \"row_totals\": {\n        \"type\": \"object\",\n        \"description\": \"Row totaling configuration\"\n      },\n      \"fill_fields\": {\n        \"type\": \"array\",\n        \"description\": \"Fields to fill with default values\"\n      },\n      \"calculations\": {\n        \"type\": \"array\",\n        \"description\": \"Custom calculated fields\"\n      },\n      \"column_limit\": {\n        \"type\": \"number\",\n        \"description\": \"Maximum columns to return\"\n      },\n      \"join_via_map\": {\n        \"type\": \"object\",\n        \"description\": \"Custom join configurations\"\n      },\n      \"column_totals\": {\n        \"type\": \"object\",\n        \"description\": \"Column totaling configuration\"\n      },\n      \"userEditedSQL\": {\n        \"type\": \"string\",\n        \"description\": \"User-overridden SQL\"\n      },\n      \"dimensionIndex\": {\n        \"type\": \"number\",\n        \"description\": \"Dimension ordering\"\n      },\n      \"default_group_by\": {\n        \"type\": \"boolean\",\n        \"description\": \"Use default grouping\"\n      },\n      \"custom_summary_types\": {\n        \"type\": \"object\",\n        \"description\": \"Custom aggregation types\"\n      },\n      \"join_paths_from_topic_name\": {\n        \"type\": \"string\",\n        \"description\": \"Topic/model name for joins\"\n      }\n    },\n    \"required\": [\n      \"limit\",\n      \"sorts\",\n      \"table\",\n      \"fields\",\n      \"pivots\",\n      \"dbtMode\",\n      \"filters\",\n      \"modelId\",\n      \"version\",\n      \"controls\",\n      \"rewriteSql\",\n      \"row_totals\",\n      \"fill_fields\",\n      \"calculations\",\n      \"column_limit\",\n      \"join_via_map\",\n      \"column_totals\",\n      \"userEditedSQL\",\n      \"dimensionIndex\",\n      \"default_group_by\",\n      \"custom_summary_types\",\n      \"join_paths_from_topic_name\"\n    ]\n  }"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        4864,
        1744
      ],
      "id": "5abcf832-7ccf-4c94-a988-237be2d39bec",
      "name": "Structured Output Parser2"
    },
    {
      "parameters": {
        "jsCode": "\n// for (const item of $input.all()) {\n//   let output = JSON.parse(item.json.output);\n\n//   if (\"current_fiscal_quarter_query\" in output) {\n//     item.json.current_fiscal_quarter_query = output.current_fiscal_quarter_query;\n//   }\n\n//   if (\"previous_fiscal_quarter_query\" in output) {\n//     item.json.previous_fiscal_quarter_query = output.previous_fiscal_quarter_query;\n//   }\n  \n//   if (\"query\" in output) {\n//     item.json.query = output.query;\n//   }\n\n//   delete item.json.output;\n// }\n\n// return $input.all();\n\n\nconst results = [];\n\nfor (const item of $input.all()) {\n  let output = JSON.parse(item.json.output);\n\n  // Handle the new array format\n  if (Array.isArray(output)) {\n    // Each element in the array is a query pair for a single measure\n    for (const queryPair of output) {\n      const newItem = {\n        json: {\n          ...item.json,\n          sorted_by_measure: queryPair.sorted_by_measure,\n          current_fiscal_quarter_query: queryPair.current_fiscal_quarter_query,\n          previous_fiscal_quarter_query: queryPair.previous_fiscal_quarter_query\n        }\n      };\n      delete newItem.json.output;\n      results.push(newItem);\n    }\n  }\n  // Backwards compatibility: handle old object format\n  else if (typeof output === 'object' && output !== null) {\n    if (\"current_fiscal_quarter_query\" in output) {\n      item.json.current_fiscal_quarter_query = output.current_fiscal_quarter_query;\n    }\n    if (\"previous_fiscal_quarter_query\" in output) {\n      item.json.previous_fiscal_quarter_query = output.previous_fiscal_quarter_query;\n    }\n    if (\"query\" in output) {\n      item.json.query = output.query;\n    }\n    if (\"error\" in output) {\n      item.json.error = output.error;\n      item.json.details = output.details;\n    }\n    delete item.json.output;\n    results.push(item);\n  }\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5600,
        1504
      ],
      "id": "e17ce027-26fc-465a-87d1-098a4fd7e0b0",
      "name": "Parse Modified Query AI Output1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<role>\nYou are a JSON-transformation agent who edits BI-tool query objects.\n</role>\n\n<task>\nGoal: Produce two modified copies of the supplied query JSON.\n\nPlan of action (follow sequentially):\n1. Parse the input JSON exactly as received; preserve every field order and value.\n2. Locate the first object inside \"filters\" whose inner field \"kind\" equals \"TIME_FOR_UNIT_DURATION\" (case-sensitive).\n3. Duplicate the entire query twice:\n   a. In Copy 1, replace that object’s \"left_side\" value with the provided {current_fiscal_quarter}.\n   b. In Copy 1, replace the numeric value in limit to 200 .\n   c. In Copy 2, replace that same \"left_side\" value with the provided {previous_fiscal_quarter} .\n   d. In Copy 2, replace the numeric value in limit to 200 .\n4. Return a json object with the structured output in the format of output_format with the two edited JSON objects in the for each key: current_fiscal_quarter_query and previous_fiscal_quarter_query\n</task>\n\n<context>\nYou will receive:\n• A complete JSON object named query.\n• Two strings: \n  – current_fiscal_quarter  \n  – previous_fiscal_quarter  \n\nReplace **ONLY** the \"left_side\" value of the filter having \"kind\": \"TIME_FOR_UNIT_DURATION\" and the numeric value for limit. All other content must remain bit-for-bit identical, including whitespace and ordering.  We prefer the simplest workflow that fully handles edge cases and follows security-best practices.\n</context>\n\n<examples>\nInput:\n\n```json\n{\n  \"query\": { ...original JSON... },\n  \"current_fiscal_quarter\": \"FY2026 Q2\",\n  \"previous_fiscal_quarter\": \"FY2026 Q1\"\n}\n\n```\n\nExpected high-level output (schema only):\n\n```json\n{\n  \"current_fiscal_quarter_query\": { /* query with FY2026 Q2 in left_side */ },\n  \"previous_fiscal_quarter_query\": { /* query with FY2026 Q1 in left_side */ }\n}\n```\n</examples>\n\n<input>\n{\n  \"query\": {{ $json.query.toJsonString() }},\n  \"current_fiscal_quarter\": \"{{  $('Fiscal Quarter Extractor').item.json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').item.json.output.previous_fiscal_quarter }}\"\n}\n</input>\n\n<guidelines>\n- Preserve JSON formatting exactly; do not pretty-print or minify.\n- Do not alter any other filters, even if they also contain TIME_* kinds.\n- If no matching filter exists, return an error object explaining “TIME_FOR_UNIT_DURATION filter not found”.\n- Point out any ambiguities or missing data instead of guessing.\n- Do not simply agree; highlight logical or data issues and propose corrections.\n- Mention tricky edge cases (e.g., multiple TIME_FOR_UNIT_DURATION filters, malformed JSON).\n- Output only valid JSON or an error object - no commentary, nor preamble.\n</guidelines>\n",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3920,
        2448
      ],
      "id": "3a3a4333-4773-44f9-8d18-103b318fbe67",
      "name": "OLD Query JSON Modifier",
      "disabled": true
    },
    {
      "parameters": {
        "model": "gpt-5-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
      "typeVersion": 1,
      "position": [
        3904,
        2640
      ],
      "id": "0b5d49f3-9f62-4323-93f5-bf49acbe8642",
      "name": "OLD gpt-5-mini",
      "credentials": {
        "azureOpenAiApi": {
          "id": "ljEp6Un527XmKGRN",
          "name": "Azure OpenAI gpt-5-mini"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "model": "gpt-5-mini",
        "options": {
          "timeout": 360000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
      "typeVersion": 1,
      "position": [
        5104,
        1728
      ],
      "id": "c307facc-4098-4a60-a627-d4538284d845",
      "name": "gpt-5-mini",
      "credentials": {
        "azureOpenAiApi": {
          "id": "ljEp6Un527XmKGRN",
          "name": "Azure OpenAI gpt-5-mini"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<role>\nYou are a JSON-transformation agent who generates multiple BI-tool query pairs for fiscal quarter comparisons, with each pair sorted by a single numeric measure.\n</role>\n\n<task>\nGoal: Produce an **array of query pairs**, one pair per numeric measure, where each pair contains queries sorted by a single measure with different fiscal quarter filters.\n\nPlan of action (follow sequentially):\n1. Parse the input JSON exactly as received; preserve every field order and value.\n2. **Identify Measures**: Scan the \"fields\" array to identify all numeric measures using the inclusion/exclusion patterns.\n3. **Locate Filter**: Find the first object inside \"filters\" whose inner field \"kind\" equals \"TIME_FOR_UNIT_DURATION\" (case-sensitive).\n4. **Generate Query Pairs**: For each numeric measure identified:\n   a. Create a query pair object with that single measure in the \"sorts\" array.\n   b. For `current_fiscal_quarter_query`: set \"left_side\" to {current_fiscal_quarter} and \"limit\" to 200.\n   c. For `previous_fiscal_quarter_query`: set \"left_side\" to {previous_fiscal_quarter} and \"limit\" to 200.\n   d. Include `sorted_by_measure` metadata field with the measure name.\n5. **Return**: A JSON array where each element is a query pair object containing `sorted_by_measure`, `current_fiscal_quarter_query`, and `previous_fiscal_quarter_query`.\n   </task>\n\n<context>\nYou will receive:\n• A complete JSON object named \"query\" following Omni analytics query structure\n• Two strings:\n  – current_fiscal_quarter\n  – previous_fiscal_quarter\n\nThe query object contains these key fields:\n- **fields**: Array of column names to SELECT and display (format: \"schema__table.field_name\")\n- **sorts**: Array of sort configuration objects (you will modify this)\n- **filters**: Object containing WHERE clause conditions\n- **limit**: Numeric value for row limit (you will set this to 200)\n- **table**: String reference to the data table\n- **modelId**: Omni model identifier (UUID)\n- **version**: Query schema version\n- **Other fields**: pivots, calculations, etc. (preserve unchanged)\n\nModify **ONLY** the \"sorts\" array (replacing it with a single-measure sort), the \"left_side\" value of the TIME_FOR_UNIT_DURATION filter, and the \"limit\" value. All other content must remain bit-for-bit identical, including whitespace and ordering. We prefer the simplest workflow that fully handles edge cases and follows security-best practices.\n</context>\n\n<numeric_measure_identification>\n<step_1>\n<description>\nIdentify Numeric Measures in Fields Array\n\nScan the \"fields\" array and identify numeric measures using these patterns:\n</description>\n\n<inclusion_patterns>\nInclusion Patterns (these ARE numeric measures):\n- `total_*` → e.g., total_ending_arr, total_customers, total_new_arr\n- `*_arr` → e.g., new_arr, upsell_arr, churn_arr, downsell_arr\n- `*_sum` → e.g., revenue_sum, new_arr_sum\n- `*_count` → e.g., opportunity_count, customer_count\n- `*_max`, `*_min` → e.g., lake_gbs_customer_data_max, min_date\n- `*_avg`, `*_average`, `*_mean` → e.g., avg_deal_size, mean_time_to_close\n- `*_gb`, `*_tb`, `*_bytes` → e.g., total_cloud_stream_in_gb_30d, total_edge_in_bytes\n- `*_nodes`, `*_instances` → e.g., total_edge_nodes, cloud_edge_nodes_30d\n- `*_percentage`, `*_percent`, `*_rate`, `*_ratio` → percentage/ratio metrics\n- `*_revenue`, `*_bookings`, `*_billings` → financial metrics\n- `*_headcount`, `*_employees`, `*_users` → when aggregated\n- `*_derived` → e.g., new_arr_derived, calculated_revenue_derived\n- `cumulative_*` → e.g., cumulative_revenue\n- `max_*`, `min_*` → e.g., max_edge_nodes, min_starting_arr\n  </inclusion_patterns>\n\n<exclusion_patterns>\nExclusion Patterns (these are NOT numeric measures - they're dimensions):\n- `*_name`, `*_title` → e.g., customer_name, account_name, owner_name\n- `*_id` → e.g., cribl_id, org_id, opportunity_id (identifiers are dimensions)\n- `*_date`, `*_time`, `*_timestamp` → e.g., close_date, created_at\n- `*_type`, `*_category`, `*_status` → e.g., customer_type, stage_name\n- `*_description`, `*_notes` → text descriptions\n- `is_*`, `has_*` → e.g., is_last_day_of_fq, is_active (boolean flags)\n- Fields with `[transformations]` → e.g., fiscal_quarter[fiscal_quarter], first_purchase_quarter[date]\n- `owner_*`, `created_by_*`, `updated_by_*` → user references\n- `*_key` → lookup keys\n  </exclusion_patterns>\n\n<pattern_matching_rules>\nPattern Matching Rules (Regex):\n```\nINCLUDE if field name matches ANY of:\n  - ^.*total_.*$              (contains \"total_\")\n  - ^.*_arr$                  (ends with \"_arr\")\n  - ^.*_sum$                  (ends with \"_sum\")\n  - ^.*_count$                (ends with \"_count\")\n  - ^.*_max$                  (ends with \"_max\")\n  - ^.*_min$                  (ends with \"_min\")\n  - ^.*_avg$|^.*_mean$        (ends with \"_avg\" or \"_mean\")\n  - ^.*_gb.*$|^.*_bytes.*$    (contains \"_gb\" or \"_bytes\")\n  - ^.*_nodes.*$              (contains \"_nodes\")\n  - ^.*_derived$              (ends with \"_derived\")\n  - ^max_.*$|^min_.*$         (starts with \"max_\" or \"min_\")\n  - ^cumulative_.*$           (starts with \"cumulative_\")\n\nEXCLUDE if field name matches ANY of:\n  - ^.*_name$|^.*_title$      (ends with \"_name\" or \"_title\")\n  - ^.*_id$                   (ends with \"_id\")\n  - ^.*date.*$|^.*quarter.*$  (contains \"date\" or \"quarter\")\n  - ^.*_at$                   (ends with \"_at\")\n  - ^.*_type$|^.*_status$     (ends with \"_type\" or \"_status\")\n  - ^.*_stage$                (ends with \"_stage\")\n  - ^is_.*$|^has_.*$          (starts with \"is_\" or \"has_\")\n  - ^.*\\[.*\\]$                (contains brackets)\n```\n</pattern_matching_rules>\n\n<example_field_analysis>\nExample Field Analysis:\n- `finance__customer_quarterly_arr.total_customers` → ✅ NUMERIC MEASURE (matches `total_*`)\n- `finance__customer_quarterly_arr.customer_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.total_arr` → ✅ NUMERIC MEASURE (matches `total_*` and `*_arr`)\n- `finance__customer_quarterly_arr.fiscal_quarter_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.new_arr_sum` → ✅ NUMERIC MEASURE (matches `*_sum`)\n- `finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]` → ❌ DIMENSION (has brackets)\n  </example_field_analysis>\n  </step_1>\n  </numeric_measure_identification>\n\n<sort_object_creation>\n<step_2>\n<description>\nIdentify Measures for Individual Query Generation\n\nFor each identified numeric measure, you will create a **separate query pair**. Each query pair will have a single-element \"sorts\" array containing only that measure:\n\n```json\n{\n  \"column_name\": \"schema__table.field_name\",\n  \"sort_descending\": true\n}\n```\n</description>\n\n<field_definitions>\nField Definitions:\n- **column_name** (required, string): The exact field reference from the fields array\n- **sort_descending** (required, boolean): Set to `true` for descending sort (largest values first)\n  </field_definitions>\n\n<sort_direction_guidelines>\nSort Direction Guidelines:\n- Numeric measures: Use `true` (descending) to show largest values first\n- This is the standard for BI tools to show \"top performers\" or \"highest values\"\n  </sort_direction_guidelines>\n\n<one_measure_per_query>\nOne Measure Per Query:\n- Each query pair is sorted by exactly ONE measure\n- If there are N numeric measures, you will generate N query pairs\n- Existing sorts in the input are **replaced entirely** (not appended to)\n- Each query pair's sorts array contains a single sort object\n</one_measure_per_query>\n\n<example>\nExample:\nInput fields:\n```json\n[\n  \"finance__customer_quarterly_arr.customer_name\",\n  \"finance__customer_quarterly_arr.total_ending_arr\",\n  \"finance__customer_quarterly_arr.total_new_arr\"\n]\n```\n\nIdentified numeric measures:\n1. `finance__customer_quarterly_arr.total_ending_arr`\n2. `finance__customer_quarterly_arr.total_new_arr`\n\nThis will result in **2 query pairs**:\n- Query pair 1: sorted by `total_ending_arr` only\n- Query pair 2: sorted by `total_new_arr` only\n\nNote: `customer_name` is excluded because it ends with `_name` (dimension, not measure).\n</example>\n</step_2>\n</sort_object_creation>\n\n<query_modification>\n<step_3>\n<description>\nGenerate Multiple Query Copies - One Per Measure\n\nFor each numeric measure identified, create a separate query pair. Each pair contains two queries (current and previous FQ), both sorted by that single measure.\n</description>\n\n<input_query>\nInput Query:\n```json\n{\n  \"sorts\": [],\n  \"fields\": [\n    \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n    \"finance__customer_quarterly_arr.total_customers\",\n    \"finance__customer_quarterly_arr.total_arr\"\n  ]\n}\n```\n\nNumeric measures identified: `total_customers`, `total_arr` (2 measures)\n</input_query>\n\n<output_query_pairs>\nOutput: Array with 2 query pairs\n\n**Query Pair 1 - Sorted by total_customers:**\n```json\n{\n  \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_customers\",\n  \"current_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_customers\", \"sort_descending\": true }],\n    /* ... rest of query with current FQ filter, limit: 200 */\n  },\n  \"previous_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_customers\", \"sort_descending\": true }],\n    /* ... rest of query with previous FQ filter, limit: 200 */\n  }\n}\n```\n\n**Query Pair 2 - Sorted by total_arr:**\n```json\n{\n  \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_arr\",\n  \"current_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_arr\", \"sort_descending\": true }],\n    /* ... rest of query with current FQ filter, limit: 200 */\n  },\n  \"previous_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_arr\", \"sort_descending\": true }],\n    /* ... rest of query with previous FQ filter, limit: 200 */\n  }\n}\n```\n</output_query_pairs>\n</step_3>\n</query_modification>\n\n<fiscal_quarter_modification>\n<step_4>\n<description>\nModify Fiscal Quarter Filter and Limit\n\nAfter adding sorts, locate and modify the TIME_FOR_UNIT_DURATION filter:\n\n1. Find the first filter object where `\"kind\": \"TIME_FOR_UNIT_DURATION\"`\n2. Note the current \"left_side\" value\n3. Prepare to create two copies with different left_side values\n   </description>\n\n<filter_structure>\nFilter Structure:\n```json\n{\n  \"type\": \"date\",\n  \"kind\": \"TIME_FOR_UNIT_DURATION\",\n  \"left_side\": \"FY2026 Q1\",\n  \"right_side\": {\n    \"unit\": \"fiscal_quarter\",\n    \"count\": 1\n  }\n}\n```\n</filter_structure>\n\n<modifications_for_each_copy>\nModifications for Each Copy:\n- **Copy 1 (current_fiscal_quarter_query)**:\n   - Set `left_side` to {current_fiscal_quarter}\n   - Set `limit` to 200\n- **Copy 2 (previous_fiscal_quarter_query)**:\n   - Set `left_side` to {previous_fiscal_quarter}\n   - Set `limit` to 200\n     </modifications_for_each_copy>\n     </step_4>\n     </fiscal_quarter_modification>\n\n<examples>\n<complete_example>\n<input>\n```json\n{\n  \"query\": {\n    \"limit\": 1000,\n    \"sorts\": [],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q1\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  },\n  \"current_fiscal_quarter\": \"FY2026 Q2\",\n  \"previous_fiscal_quarter\": \"FY2026 Q1\"\n}\n```\n</input>\n\n<processing_steps>\nProcessing Steps:\n\n**Step 1: Identify numeric measures**\n- ❌ `fiscal_quarter_name` → ends with `_name` (dimension)\n- ✅ `total_customers` → matches `total_*` (measure)\n- ✅ `total_arr` → matches `total_*` and `*_arr` (measure)\n\n**Result:** 2 numeric measures identified → will generate 2 query pairs\n\n**Step 2: Prepare query pairs**\n- Query pair 1: sorted by `total_customers`\n- Query pair 2: sorted by `total_arr`\n\n**Step 3: Find TIME_FOR_UNIT_DURATION filter**\n\n**Step 4: Generate array of query pairs with FQ variations**\n</processing_steps>\n\n<expected_output>\n```json\n[\n  {\n    \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_customers\",\n    \"current_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q2\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    },\n    \"previous_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q1\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    }\n  },\n  {\n    \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_arr\",\n    \"current_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q2\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    },\n    \"previous_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q1\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    }\n  }\n]\n```\n</expected_output>\n</complete_example>\n</examples>\n\n<input>\n{\n  \"query\": {{ $json.query.toJsonString() }},\n  \"current_fiscal_quarter\": \"{{  $('Fiscal Quarter Extractor').item.json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').item.json.output.previous_fiscal_quarter }}\"\n}\n</input>\n\n<edge_cases>\n<description>\nEdge Cases to Handle\n</description>\n\n<case_1>\n1. Query with existing sorts:\n- Existing sorts are **replaced entirely** with the single measure sort\n- Each query pair gets a fresh sorts array with only one sort object\n- The original sorts array is NOT preserved\n\n**Example Input:**\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"sales__opportunity.new_arr_derived\",\n      \"sort_descending\": true\n    }\n  ],\n  \"fields\": [\n    \"sales__opportunity.account_name\",\n    \"sales__opportunity.new_arr_derived\",\n    \"sales__opportunity.total_arr\"\n  ]\n}\n```\n\n**Processing:**\n- Numeric measures: `new_arr_derived`, `total_arr` (2 measures)\n- Generate 2 query pairs, each with a single-element sorts array\n\n**Result:** Array with 2 query pairs\n- Query pair 1: `sorts: [{ \"column_name\": \"sales__opportunity.new_arr_derived\", ... }]`\n- Query pair 2: `sorts: [{ \"column_name\": \"sales__opportunity.total_arr\", ... }]`\n</case_1>\n\n<case_2>\n2. Query with no numeric measures:\n- Return an array with **one element** containing a query pair with empty sorts\n\n**Example Input:**\n```json\n{\n  \"fields\": [\n    \"sales__accounts.account_name\",\n    \"sales__accounts.owner_name\",\n    \"sales__opportunity.close_date\"\n  ],\n  \"sorts\": []\n}\n```\n\n**Result:**\n```json\n[\n  {\n    \"sorted_by_measure\": null,\n    \"current_fiscal_quarter_query\": {\n      \"sorts\": [],\n      /* ... rest of query with current FQ filter, limit: 200 */\n    },\n    \"previous_fiscal_quarter_query\": {\n      \"sorts\": [],\n      /* ... rest of query with previous FQ filter, limit: 200 */\n    }\n  }\n]\n```\n</case_2>\n\n<case_3>\n3. Query with single numeric measure:\n- Return an array with **one element** containing a query pair sorted by that measure\n\n**Example Input:**\n```json\n{\n  \"fields\": [\n    \"sales__accounts.account_name\",\n    \"sales__opportunity.total_arr\"\n  ]\n}\n```\n\n**Result:** Array with 1 query pair, sorted by `total_arr`\n</case_3>\n\n<case_4>\n4. Query with mixed numeric and dimension fields:\n- Only generate query pairs for true numeric measures\n- Skip all dimension fields even if they contain numbers in their values\n  </case_4>\n\n<case_5>\n5. Multiple TIME_FOR_UNIT_DURATION filters:\n- Only modify the FIRST occurrence\n- Leave other TIME_* filters unchanged\n  </case_5>\n\n<case_6>\n6. Missing TIME_FOR_UNIT_DURATION filter:\n- Return error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n  </case_6>\n\n<case_7>\n7. Malformed JSON:\n- Return error object: `{\"error\": \"Invalid JSON structure\", \"details\": \"<specific issue>\"}`\n  </case_7>\n  </edge_cases>\n\n<guidelines>\n<description>\nProcessing Guidelines\n</description>\n\n- Preserve JSON formatting exactly; do not pretty-print or minify.\n- Generate one query pair per numeric measure identified.\n- Each query pair's sorts array contains **exactly one** sort object for that measure.\n- Existing sorts in the input query are **replaced entirely** - do not append to them.\n- Do not alter any filters except the first TIME_FOR_UNIT_DURATION filter's left_side value.\n- If no matching TIME_FOR_UNIT_DURATION filter exists, return an error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n- Point out any ambiguities or missing data instead of guessing.\n- Do not simply agree with assumptions; highlight logical or data issues and propose corrections.\n- Mention tricky edge cases when they occur.\n- Output only valid JSON array or an error object - no commentary, preamble, or markdown formatting.\n- Within each query pair, both queries must have identical sorts arrays (the same single measure).\n- Set limit to exactly 200 in all output queries.\n- All queries should be complete, valid Omni query objects.\n- If no numeric measures are found, return an array with one element where `sorted_by_measure` is `null` and sorts arrays are empty.\n  </guidelines>\n\n<output_format>\n<description>\nExpected Output Structure\n\nThe output is a **JSON array** where each element represents a query pair sorted by a single numeric measure.\n</description>\n\n```json\n[\n  {\n    \"sorted_by_measure\": \"schema__table.measure_name_1\",\n    \"current_fiscal_quarter_query\": {\n      /* Complete query object with:\n         - sorts: single-element array with ONE measure sort\n         - limit: 200\n         - filters: TIME_FOR_UNIT_DURATION.left_side = current_fiscal_quarter\n         - all other fields: unchanged\n      */\n    },\n    \"previous_fiscal_quarter_query\": {\n      /* Complete query object with:\n         - sorts: single-element array with same ONE measure sort\n         - limit: 200\n         - filters: TIME_FOR_UNIT_DURATION.left_side = previous_fiscal_quarter\n         - all other fields: unchanged\n      */\n    }\n  },\n  {\n    \"sorted_by_measure\": \"schema__table.measure_name_2\",\n    \"current_fiscal_quarter_query\": { /* sorted by measure_2 */ },\n    \"previous_fiscal_quarter_query\": { /* sorted by measure_2 */ }\n  }\n  /* ... one element per numeric measure */\n]\n```\n\n<field_definitions>\nArray Element Fields:\n- **sorted_by_measure** (string | null): The full measure name this query pair is sorted by. Set to `null` if no numeric measures exist.\n- **current_fiscal_quarter_query** (object): Query with current FQ filter and limit: 200\n- **previous_fiscal_quarter_query** (object): Query with previous FQ filter and limit: 200\n</field_definitions>\n\nIf there's an error:\n```json\n{\n  \"error\": \"Error description\",\n  \"details\": \"Specific issue details\"\n}\n```\n</output_format>\n\n<validation_checklist>\n<description>\nValidation Before Returning\n\nVerify the following before returning the result:\n</description>\n\n- [ ] Output is a JSON **array** (not an object)\n- [ ] Array has N elements where N = number of numeric measures (or 1 element if no measures)\n- [ ] Each array element has all three keys: `sorted_by_measure`, `current_fiscal_quarter_query`, `previous_fiscal_quarter_query`\n- [ ] Each `sorted_by_measure` is a valid measure name string (or `null` if no measures)\n- [ ] Each query's \"sorts\" array has **exactly one** sort object (or empty array if no measures)\n- [ ] Each sort object has both \"column_name\" and \"sort_descending\" fields\n- [ ] All \"sort_descending\" values are `true`\n- [ ] Both queries in each pair have \"limit\" set to 200\n- [ ] Current query has correct current_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Previous query has correct previous_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Both queries in each pair have **identical** \"sorts\" arrays (same single measure)\n- [ ] No dimension fields (names, IDs, dates) appear as `sorted_by_measure`\n- [ ] All other fields (table, modelId, version, etc.) are preserved unchanged in each query\n- [ ] The output is valid JSON with no syntax errors\n  </validation_checklist>\n",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        5152,
        1504
      ],
      "id": "a9cca20c-75ad-4dbd-ae3f-c04559bb043e",
      "name": "Query JSON Modifier"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "board-deck-takeaways-ze5ubv1w",
        "authentication": "basicAuth",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        224,
        1392
      ],
      "id": "6ed5e716-a593-43f8-a2a5-ff2b55e7606a",
      "name": "Trigger",
      "webhookId": "1298ec1c-5d6c-4010-9b21-b40fada0aa39",
      "alwaysOutputData": true,
      "credentials": {
        "httpBasicAuth": {
          "id": "3AVUqEU99hkVKUOW",
          "name": "Zapier Inbound Basic Auth Webhook"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "noData",
        "options": {
          "responseCode": 202
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        480,
        1392
      ],
      "id": "ee9d858a-7473-476a-8e2d-509ceb132fb6",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "KNaGu0JiDRPuHSkx",
          "mode": "list",
          "cachedResultUrl": "/workflow/KNaGu0JiDRPuHSkx",
          "cachedResultName": "Board_Deck_Omni_Query_Analysis_Subworkflow"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "current_fiscal_quarter_query": "={{ $json.current_fiscal_quarter_query }}",
            "previous_fiscal_quarter_query": "={{ $json.previous_fiscal_quarter_query }}",
            "document_query_id": "={{ $json.document_query_id }}",
            "document_query_name": "={{ $json.document_query_name }}",
            "drill_name": "={{ $json.drill_name }}",
            "current_fiscal_quarter": "={{ $json.current_fiscal_quarter }}",
            "previous_fiscal_quarter": "={{ $json.previous_fiscal_quarter }}",
            "current_fiscal_half": "={{ $json.current_fiscal_half }}",
            "previous_fiscal_half": "={{ $json.previous_fiscal_half }}",
            "user_id": "={{ $json.user_id }}",
            "google_document_id": "={{ $json.google_document_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "current_fiscal_quarter_query",
              "displayName": "current_fiscal_quarter_query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "previous_fiscal_quarter_query",
              "displayName": "previous_fiscal_quarter_query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "document_query_id",
              "displayName": "document_query_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "document_query_name",
              "displayName": "document_query_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "drill_name",
              "displayName": "drill_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "current_fiscal_quarter",
              "displayName": "current_fiscal_quarter",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "previous_fiscal_quarter",
              "displayName": "previous_fiscal_quarter",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "current_fiscal_half",
              "displayName": "current_fiscal_half",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "previous_fiscal_half",
              "displayName": "previous_fiscal_half",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "google_document_id",
              "displayName": "google_document_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        6640,
        1696
      ],
      "id": "9b83e1fc-e191-413b-805b-996c7d5de321",
      "name": "Call 'Board_Deck_Omni_Query_Analysis_Subworkflow'"
    },
    {
      "parameters": {
        "resource": "folder",
        "name": "=Board_Deck_Takeaways_{{ $now.format('yyyyMMdd_HHmmss') }}",
        "driveId": {
          "__rl": true,
          "value": "My Drive",
          "mode": "list",
          "cachedResultName": "My Drive",
          "cachedResultUrl": "https://drive.google.com/drive/my-drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1dSd5PWJ0BH1ksydt-GnYJraDhwLnAbGZ",
          "mode": "list",
          "cachedResultName": "AI Workflow - Board Deck Takeaways",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1dSd5PWJ0BH1ksydt-GnYJraDhwLnAbGZ"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1600,
        1120
      ],
      "id": "15d9460c-b80f-4f00-9421-f1073c6e8a94",
      "name": "Create folder",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "SgST8lxFUWMslYat",
          "name": "Google Drive Cribl"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": []
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3424,
        1280
      ],
      "id": "2644febc-6619-4de2-ac6c-b17278e1c02d",
      "name": "Loop UUID Item"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": []
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4736,
        1504
      ],
      "id": "146faf1b-dcc0-44f5-8699-57d5106857e3",
      "name": "Loop Query Item"
    },
    {
      "parameters": {
        "driveId": "0AMo0z91EPlT1Uk9PVA",
        "folderId": "=1omG14xnIzyoMcZvRqAIdiSPm4U9DFppR",
        "title": "={{ $('Loop Over UUIDs').item.json.document_query_name }}"
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        3744,
        1456
      ],
      "id": "e61568b1-3b9b-4c59-98c9-ba817d46fe30",
      "name": "Create Takeaways Doc Shared Drive",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "dzy8xbOq7YSB6444",
          "name": "Google Docs Cribl"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "folderId": "={{ $('Create folder').item.json.id }}",
        "title": "={{ $json.document_query_name }}"
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        3744,
        1280
      ],
      "id": "6457a53e-148f-4261-8fcd-82c8662ab477",
      "name": "Create Takeaways Doc",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "dzy8xbOq7YSB6444",
          "name": "Google Docs Cribl"
        }
      }
    },
    {
      "parameters": {
        "content": "- No matter how many drill query sort versions that a drill query has, this loop (which goes for each drill query) should only still input one takeaway per drill query"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5520,
        2048
      ],
      "typeVersion": 1,
      "id": "6c326fa0-6fd2-4005-ab4b-69c5de620beb",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "- No matter how many drill queries (and thus drill query sort versions) that a document query has, this loop (which goes for each document query/chart) should only still create one google doc within the folder per document query",
        "height": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3456,
        1760
      ],
      "typeVersion": 1,
      "id": "8dc7f025-9cef-4f86-9278-e4d352662333",
      "name": "Sticky Note3"
    }
  ],
  "connections": {
    "When clicking 'Execute workflow'": {
      "main": [
        [
          {
            "node": "Global Vars",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Global Vars": {
      "main": [
        [
          {
            "node": "Fiscal Quarter Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Drill Queries": {
      "main": [
        [
          {
            "node": "Get Drill Queries Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over UUIDs": {
      "main": [
        [
          {
            "node": "Initialize finishedSet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop UUID Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Queries": {
      "main": [
        [
          {
            "node": "Loop Over UUIDs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Query Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST Drill Query": {
      "main": [
        []
      ]
    },
    "Prepare UUID Loop Data": {
      "main": [
        [
          {
            "node": "Loop Over UUIDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Queries for UUID": {
      "main": [
        [
          {
            "node": "Loop Over Queries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Callback Wait": {
      "main": [
        [
          {
            "node": "Update finishedSet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update finishedSet": {
      "main": [
        [
          {
            "node": "Acknowledge Finished",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize finishedSet": {
      "main": [
        [
          {
            "node": "If All Finished",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If All Finished": {
      "main": [
        [
          {
            "node": "Continue Workflow (noop)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Webhook Callback Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acknowledge Finished": {
      "main": [
        [
          {
            "node": "If All Finished",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Drill Queries Count": {
      "main": [
        [
          {
            "node": "Prepare UUID Loop Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Loop Over Queries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Fiscal Quarter Extractor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Fiscal Quarter Extractor": {
      "main": [
        [
          {
            "node": "Create folder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        []
      ]
    },
    "Parse Modified Query AI Output": {
      "main": [
        []
      ]
    },
    "o4-mini": {
      "ai_languageModel": [
        [
          {
            "node": "Fiscal Quarter Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Create Request Payload": {
      "main": [
        [
          {
            "node": "Call 'Board_Deck_Omni_Query_Analysis_Subworkflow'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser2": {
      "ai_outputParser": [
        []
      ]
    },
    "Parse Modified Query AI Output1": {
      "main": [
        [
          {
            "node": "Create Request Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OLD Query JSON Modifier": {
      "main": [
        [
          {
            "node": "Parse Modified Query AI Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OLD gpt-5-mini": {
      "ai_languageModel": [
        [
          {
            "node": "OLD Query JSON Modifier",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "gpt-5-mini": {
      "ai_languageModel": [
        [
          {
            "node": "Query JSON Modifier",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Query JSON Modifier": {
      "main": [
        [
          {
            "node": "Parse Modified Query AI Output1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook": {
      "main": [
        [
          {
            "node": "Global Vars",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'Board_Deck_Omni_Query_Analysis_Subworkflow'": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create folder": {
      "main": [
        [
          {
            "node": "Load Drill Queries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop UUID Item": {
      "main": [
        [
          {
            "node": "Create Takeaways Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Query Item": {
      "main": [
        [
          {
            "node": "Query JSON Modifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Takeaways Doc Shared Drive": {
      "main": [
        []
      ]
    },
    "Create Takeaways Doc": {
      "main": [
        [
          {
            "node": "Extract Queries for UUID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "OLD Query JSON Modifier": [
      {
        "json": {
          "output": "{\n  \"current_fiscal_quarter_query\": {\"limit\":200,\"sorts\":[],\"table\":\"cloud_edge_nodes_fq\",\"fields\":[\"cloud_edge_nodes_fq.date[fiscal_quarter]\",\"cloud_edge_nodes_fq.org_id\",\"cloud_edge_nodes_fq.total_edge_nodes\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"cloud_edge_nodes_fq.date\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"product__cloud_orgs.org_type\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"Customer\",\"Free\"],\"is_negative\":false},\"cloud_edge_nodes_fq.total_edge_nodes\":{\"kind\":\"GREATER_THAN\",\"type\":\"number\",\"values\":[\"0\"],\"is_negative\":false,\"is_inclusive\":false}},\"modelId\":\"912e8580-4519-4971-b8c3-1c30608c7f49\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"cloud_edge_nodes_fq\"},\n  \"previous_fiscal_quarter_query\": {\"limit\":200,\"sorts\":[],\"table\":\"cloud_edge_nodes_fq\",\"fields\":[\"cloud_edge_nodes_fq.date[fiscal_quarter]\",\"cloud_edge_nodes_fq.org_id\",\"cloud_edge_nodes_fq.total_edge_nodes\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"cloud_edge_nodes_fq.date\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"product__cloud_orgs.org_type\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"Customer\",\"Free\"],\"is_negative\":false},\"cloud_edge_nodes_fq.total_edge_nodes\":{\"kind\":\"GREATER_THAN\",\"type\":\"number\",\"values\":[\"0\"],\"is_negative\":false,\"is_inclusive\":false}},\"modelId\":\"912e8580-4519-4971-b8c3-1c30608c7f49\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"cloud_edge_nodes_fq\"}\n}"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Trigger": [
      {
        "json": {
          "name": "First item",
          "code": 1
        }
      }
    ],
    "Query JSON Modifier": [
      {
        "json": {
          "output": "[{\"sorted_by_measure\":\"finance__customer_quarterly_arr.total_starting_arr\",\"current_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_starting_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"},\"previous_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_starting_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"}},{\"sorted_by_measure\":\"finance__customer_quarterly_arr.total_new_arr\",\"current_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_new_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"},\"previous_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_new_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"}},{\"sorted_by_measure\":\"finance__customer_quarterly_arr.total_upsell_arr\",\"current_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_upsell_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"},\"previous_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_upsell_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"}},{\"sorted_by_measure\":\"finance__customer_quarterly_arr.total_churn_arr\",\"current_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_churn_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"},\"previous_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_churn_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"}},{\"sorted_by_measure\":\"finance__customer_quarterly_arr.total_downsell_arr\",\"current_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_downsell_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"},\"previous_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_downsell_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"}},{\"sorted_by_measure\":\"finance__customer_quarterly_arr.total_ending_arr\",\"current_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_ending_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"},\"previous_fiscal_quarter_query\":{\"limit\":200,\"sorts\":[{\"column_name\":\"finance__customer_quarterly_arr.total_ending_arr\",\"sort_descending\":true}],\"table\":\"finance__customer_quarterly_arr\",\"fields\":[\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\"finance__customer_quarterly_arr.customer_name\",\"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\"finance__customer_quarterly_arr.cribl_id\",\"finance__customer_quarterly_arr.customer_type\",\"finance__customer_quarterly_arr.total_starting_arr\",\"finance__customer_quarterly_arr.total_new_arr\",\"finance__customer_quarterly_arr.total_upsell_arr\",\"finance__customer_quarterly_arr.total_churn_arr\",\"finance__customer_quarterly_arr.total_downsell_arr\",\"finance__customer_quarterly_arr.total_ending_arr\"],\"pivots\":[],\"dbtMode\":false,\"filters\":{\"finance__customer_quarterly_arr.fiscal_quarter\":{\"type\":\"composite\",\"filters\":[{\"kind\":\"TIME_FOR_UNIT_DURATION\",\"type\":\"date\",\"left_side\":\"\"},{\"kind\":\"TIME_FOR_INTERVAL_DURATION\",\"type\":\"date\",\"left_side\":\"6 complete fiscal quarters ago\",\"right_side\":\"6 quarters\",\"is_negative\":false}],\"conjunction\":\"AND\",\"is_negative\":false},\"finance__customer_quarterly_arr.source_granularity\":{\"kind\":\"EQUALS\",\"type\":\"string\",\"values\":[\"cloud\"]}},\"modelId\":\"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\"version\":8,\"controls\":[],\"rewriteSql\":true,\"row_totals\":{},\"fill_fields\":[],\"calculations\":[],\"column_limit\":50,\"join_via_map\":{},\"column_totals\":{},\"userEditedSQL\":\"\",\"dimensionIndex\":0,\"default_group_by\":true,\"custom_summary_types\":{},\"join_paths_from_topic_name\":\"customer_quarterly_arr\"}}]"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Fiscal Quarter Extractor": [
      {
        "json": {
          "output": {
            "today": "2026-01-23",
            "current_fiscal_quarter": "FY2026 Q3",
            "previous_fiscal_quarter": "FY2026 Q2",
            "current_fiscal_half": "FY2026 H2",
            "previous_fiscal_half": "FY2026 H1"
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Create folder": [
      {
        "json": {
          "kind": "drive#file",
          "id": "1i-Q0pCIIHsMtRC1GelGp1mTdrTa777MZ",
          "name": "Board_Deck_Takeaways_20260123_182411",
          "mimeType": "application/vnd.google-apps.folder"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Create Takeaways Doc": [
      {
        "json": {
          "kind": "drive#file",
          "id": "1RI2VYYgam1TWgKKJTmPqyKMlZ7D__nSg5SdNiPbxHTQ",
          "name": "Incremental Cloud ARR and Customers Over Time",
          "mimeType": "application/vnd.google-apps.document"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "ca109958-9630-48b3-9eb1-be2bc72df506",
  "activeVersionId": "ca109958-9630-48b3-9eb1-be2bc72df506",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-12-20T02:14:15.842Z",
      "createdAt": "2025-12-20T02:14:15.842Z",
      "role": "workflow:owner",
      "workflowId": "4cCsYYYaNoTNWB3U",
      "projectId": "2vHf2VxAoKk0WgJE"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-24T04:01:57.955Z",
    "createdAt": "2026-01-24T04:01:57.955Z",
    "versionId": "ca109958-9630-48b3-9eb1-be2bc72df506",
    "workflowId": "4cCsYYYaNoTNWB3U",
    "nodes": [
      {
        "parameters": {},
        "id": "trigger1",
        "name": "When clicking 'Execute workflow'",
        "type": "n8n-nodes-base.manualTrigger",
        "typeVersion": 1,
        "position": [
          224,
          1120
        ],
        "disabled": true
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "{\n  \"dashboard_discovery_model_version\": \"1.0\",\n  \"snowflake_base_url\": \"https://ml16699-hya89079.snowflakecomputing.com\",\n  \"omni_documents_search_service\": {\n    \"snowflake_database\": \"ANALYTICS\",\n    \"snowflake_schema\": \"OMNI\",\n    \"service_name\": \"omni_documents_search_service\"\n  },\n  \"omni_api\": {\n    \"omni_base_url\": \"https://cribl.omniapp.co\",\n    \"model_id\": \"4345b118-cbbe-4f7c-a705-ea0aa8da57c0\"\n  },\n  \"snowflake_tables\": {\n    \"omni_documents\": {\n      \"snowflake_database\": \"ANALYTICS\",\n      \"snowflake_schema\": \"OMNI\",\n      \"table_name\": \"DOCUMENTS\"\n    },\n    \"dashboard_recommendations\": {\n      \"snowflake_database\": \"RAW\",\n      \"snowflake_schema\": \"OMNI\",\n      \"table_name\": \"DASHBOARD_RECOMMENDATIONS\"\n    }\n  },\n  \"default_user_id\": \"893ce348-0fb2-44ac-b0f8-06521a341580\"\n}",
          "includeOtherFields": true,
          "include": "except",
          "excludeFields": "headers,params,query,webhookUrl,executionMode",
          "options": {}
        },
        "id": "globalVars1",
        "name": "Global Vars",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          832,
          1120
        ]
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "{\n  \"c3023df3-39f1-4913-86c8-07d69f6caeb1\": [\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_customers\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.customer_type\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\",\n          \"finance__customer_quarterly_arr.total_churn_arr\",\n          \"finance__customer_quarterly_arr.total_downsell_arr\",\n          \"finance__customer_quarterly_arr.total_ending_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    \\\"CUSTOMER_TYPE\\\" AS \\\"finance__customer_quarterly_arr.customer_type\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"CHURN_ARR\\\" < 0 THEN \\\"CHURN_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_churn_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"DOWNSELL_ARR\\\" < 0 THEN \\\"DOWNSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_downsell_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"ENDING_ARR\\\" > 0 THEN \\\"ENDING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_ending_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 5, 3, 1\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_migration_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.customer_type\",\n          \"finance__customer_quarterly_arr.total_migration_arr\",\n          \"finance__customer_quarterly_arr.migration_arr_cloud\",\n          \"finance__customer_quarterly_arr.migration_arr_software\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"df073f20-17b0-4d9c-b667-2b2f86b5fae8\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    \\\"CUSTOMER_TYPE\\\" AS \\\"finance__customer_quarterly_arr.customer_type\\\",\\n    COALESCE(SUM(\\\"MIGRATION_ARR_CLOUD\\\"), 0) AS \\\"finance__customer_quarterly_arr.total_migration_arr\\\",\\n    \\\"MIGRATION_ARR_CLOUD\\\" AS \\\"finance__customer_quarterly_arr.migration_arr_cloud\\\",\\n    \\\"MIGRATION_ARR_SOFTWARE\\\" AS \\\"finance__customer_quarterly_arr.migration_arr_software\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 5, 3, 1, 7, 8\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_gross_new_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [\n          {\n            \"column_name\": \"finance__customer_quarterly_arr.total_starting_arr\",\n            \"sort_descending\": true\n          }\n        ],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"51b818b3-a897-4ede-a516-ab7436c6be97\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 3, 1\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_gross_new_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [\n          {\n            \"column_name\": \"finance__customer_quarterly_arr.total_new_arr\",\n            \"sort_descending\": true\n          }\n        ],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"51b818b3-a897-4ede-a516-ab7436c6be97\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 3, 1\\nLIMIT 1000\"\n    },\n    {\n      \"document_query_name\": \"Incremental Cloud ARR and Customers Over Time\",\n      \"drill_name\": \"total_gross_new_arr\",\n      \"query\": {\n        \"limit\": 1000,\n        \"sorts\": [\n          {\n            \"column_name\": \"finance__customer_quarterly_arr.total_upsell_arr\",\n            \"sort_descending\": true\n          }\n        ],\n        \"table\": \"finance__customer_quarterly_arr\",\n        \"fields\": [\n          \"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\",\n          \"finance__customer_quarterly_arr.customer_name\",\n          \"finance__customer_quarterly_arr.first_purchase_quarter[date]\",\n          \"finance__customer_quarterly_arr.cribl_id\",\n          \"finance__customer_quarterly_arr.total_starting_arr\",\n          \"finance__customer_quarterly_arr.total_new_arr\",\n          \"finance__customer_quarterly_arr.total_upsell_arr\"\n        ],\n        \"pivots\": [],\n        \"dbtMode\": false,\n        \"filters\": {\n          \"finance__customer_quarterly_arr.fiscal_quarter\": {\n            \"type\": \"composite\",\n            \"filters\": [\n              {\n                \"kind\": \"TIME_FOR_UNIT_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"FY2026 Q3\"\n              },\n              {\n                \"kind\": \"TIME_FOR_INTERVAL_DURATION\",\n                \"type\": \"date\",\n                \"left_side\": \"6 complete fiscal quarters ago\",\n                \"right_side\": \"6 quarters\",\n                \"is_negative\": false\n              }\n            ],\n            \"conjunction\": \"AND\",\n            \"is_negative\": false\n          },\n          \"finance__customer_quarterly_arr.source_granularity\": {\n            \"kind\": \"EQUALS\",\n            \"type\": \"string\",\n            \"values\": [\n              \"cloud\"\n            ]\n          }\n        },\n        \"modelId\": \"51b818b3-a897-4ede-a516-ab7436c6be97\",\n        \"version\": 8,\n        \"controls\": [],\n        \"rewriteSql\": true,\n        \"row_totals\": {},\n        \"fill_fields\": [],\n        \"calculations\": [],\n        \"column_limit\": 50,\n        \"join_via_map\": {},\n        \"column_totals\": {},\n        \"userEditedSQL\": \"\",\n        \"dimensionIndex\": 0,\n        \"default_group_by\": true,\n        \"custom_summary_types\": {},\n        \"join_paths_from_topic_name\": \"customer_quarterly_arr\"\n      },\n      \"sql\": \"SELECT 'FY' || CAST(EXTRACT(YEAR FROM (\\\"FISCAL_QUARTER\\\" + INTERVAL '11 month')) AS VARCHAR) || (' Q' || CAST(CAST(FLOOR((MOD(EXTRACT(MONTH FROM \\\"FISCAL_QUARTER\\\") + -13, 12) + 12 - 1) / 3) AS BIGINT) + 1 AS VARCHAR)) AS \\\"finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]\\\",\\n    \\\"CUSTOMER_NAME\\\" AS \\\"finance__customer_quarterly_arr.customer_name\\\",\\n    CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)) AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]__raw\\\",\\n    \\\"CRIBL_ID\\\" AS \\\"finance__customer_quarterly_arr.cribl_id\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"STARTING_ARR\\\" > 0 THEN \\\"STARTING_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_starting_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"NEW_ARR\\\" > 0 THEN \\\"NEW_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_new_arr\\\",\\n    COALESCE(SUM(CASE\\n        WHEN \\\"UPSELL_ARR\\\" > 0 THEN \\\"UPSELL_ARR_CLOUD\\\"\\n        ELSE NULL\\n    END), 0) AS \\\"finance__customer_quarterly_arr.total_upsell_arr\\\",\\n    TO_CHAR(CAST(DATE_TRUNC('DAY', \\\"FIRST_PURCHASE_QUARTER\\\") AS TIMESTAMP(0)), 'YYYY-MM-DD') AS \\\"finance__customer_quarterly_arr.first_purchase_quarter[date]\\\"\\nFROM \\\"FINANCE\\\".\\\"CUSTOMER_QUARTERLY_ARR\\\" AS \\\"finance__customer_quarterly_arr\\\"\\nWHERE \\\"FISCAL_QUARTER\\\" >= CAST(TIMESTAMP '2025-08-01 00:00:00' AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', ((TIMESTAMP '2025-08-01 00:00:00' + INTERVAL '3 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" >= CAST((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE) AND \\\"FISCAL_QUARTER\\\" < CAST((DATE_TRUNC('QUARTER', (((DATE_TRUNC('QUARTER', ((CAST(CURRENT_TIMESTAMP AS TIMESTAMP(0)) + INTERVAL '-18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') + INTERVAL '18 month') + INTERVAL '2 month')) + INTERVAL '-2 month') AS DATE)\\nGROUP BY 4, 2, 3, 1\\nLIMIT 1000\"\n    }\n  ]\n}",
          "includeOtherFields": true,
          "options": {}
        },
        "id": "loadQueries1",
        "name": "Load Drill Queries",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          2064,
          1120
        ]
      },
      {
        "parameters": {
          "options": {
            "reset": false
          }
        },
        "id": "outerLoop1",
        "name": "Loop Over UUIDs",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          3152,
          1120
        ],
        "executeOnce": false
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "innerLoop1",
        "name": "Loop Over Queries",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          4432,
          1456
        ],
        "executeOnce": false
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://n8n-relayer-1.app.n8n.cloud/webhook/omni-pattern-detection-subworkflow",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "callbackurl",
                "value": "={{ $execution.resumeUrl }}"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ \n\n  $json\n}}",
          "options": {}
        },
        "id": "httpPost1",
        "name": "POST Drill Query",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          5808,
          1456
        ],
        "executeOnce": false,
        "disabled": true
      },
      {
        "parameters": {
          "jsCode": "const inputData = $('Load Drill Queries').first().json;\n  const systemFields = ['headers', 'params', 'query', 'webhookUrl', 'executionMode'];\n  const drillQueries = {};\n\n  for (const [key, value] of Object.entries(inputData)) {\n    if (!systemFields.includes(key) && typeof value === 'object' && Array.isArray(value)) {\n      drillQueries[key] = value;\n    }\n  }\n\n  const uuidKeys = Object.keys(drillQueries);\n\n  if (uuidKeys.length === 0) {\n    return [{\n      json: {\n        error: 'No drill query UUIDs found in input data',\n        inputKeys: Object.keys(inputData)\n      }\n    }];\n  }\n\n  let drill_queries = uuidKeys.map(document_query_id => ({\n    json: {\n      document_query_id: document_query_id,\n      document_query_name: drillQueries[document_query_id][0][\"document_query_name\"],\n      queries: drillQueries[document_query_id],\n      queryCount: drillQueries[document_query_id].length\n    }\n  }))\n\n  return drill_queries;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2656,
          1120
        ],
        "id": "d9071922-dd3c-4544-8313-87cd21b0b593",
        "name": "Prepare UUID Loop Data"
      },
      {
        "parameters": {
          "jsCode": "console.log($(\"Loop UUID Item\").item.json);\n\nconst currentItem = $(\"Loop UUID Item\").item.json;\n\n\nif (!currentItem.document_query_id || !currentItem.queries) {\n  return [{\n    json: {\n      error: 'Missing required fields: document_query_id or queries',\n      received: currentItem\n    }\n  }];\n}\n\nconst document_query_id = currentItem.document_query_id;\nconst queries = currentItem.queries;\n\nif (!Array.isArray(queries)) {\n  return [{\n    json: {\n      error: 'queries is not an array',\n      type: typeof queries\n    }\n  }];\n}\n\nreturn queries.map(query => ({\n  json: {\n    document_query_id: document_query_id,\n    document_query_name: query.document_query_name || '',\n    drill_name: query.drill_name || 'unnamed_drill',\n    query: query.query || {}\n  }\n}));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4112,
          1280
        ],
        "id": "5dfd4e0b-b9ab-4a4d-a846-c8ef49e931bd",
        "name": "Extract Queries for UUID"
      },
      {
        "parameters": {
          "resume": "webhook",
          "httpMethod": "POST",
          "responseMode": "responseNode",
          "options": {}
        },
        "id": "314fa1dd-a8d8-4354-80ef-da7b8dfbcc74",
        "name": "Webhook Callback Wait",
        "type": "n8n-nodes-base.wait",
        "position": [
          6672,
          672
        ],
        "webhookId": "5cd058b4-48c8-449a-9c09-959a5b8a2b48",
        "typeVersion": 1.1,
        "disabled": true
      },
      {
        "parameters": {
          "jsCode": "let json = $('If All Finished').first().json;\nif (!json.finishedSet) json.finishedSet = [];\nlet finishedItemId = $('Webhook Callback Wait').item.json.body.finishedItemId;\nif (!json.finishedSet[finishedItemId]) json.finishedSet.push(finishedItemId);\nreturn [json];"
        },
        "id": "3c2603e2-8aee-4535-9439-66fe53a931d0",
        "name": "Update finishedSet",
        "type": "n8n-nodes-base.code",
        "position": [
          7312,
          672
        ],
        "typeVersion": 2,
        "disabled": true
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "193ab8f1-0e23-491c-914e-b8b26b0160f7",
                "name": "finishedSet",
                "type": "array",
                "value": "[]"
              }
            ]
          },
          "options": {}
        },
        "id": "5ae9644b-a5ee-4306-a28b-c7ae6611c0c7",
        "name": "Initialize finishedSet",
        "type": "n8n-nodes-base.set",
        "position": [
          4176,
          512
        ],
        "executeOnce": true,
        "typeVersion": 3.4,
        "disabled": true
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "version": 1,
              "leftValue": "",
              "caseSensitive": true,
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "385c3149-3623-4dd2-9022-770c32f82421",
                "operator": {
                  "type": "number",
                  "operation": "gte"
                },
                "leftValue": "={{ $json.finishedSet.length }}",
                "rightValue": "={{ $('Get Drill Queries Count').first().json.drill_queries_count }}"
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "e9a9ea4a-2ef4-4f05-b2b6-c52a1814512c",
        "name": "If All Finished",
        "type": "n8n-nodes-base.if",
        "position": [
          5584,
          512
        ],
        "typeVersion": 2,
        "disabled": true
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "9e8c5598-babe-4684-8f76-744f71d8831c",
        "name": "Acknowledge Finished",
        "type": "n8n-nodes-base.respondToWebhook",
        "position": [
          7152,
          896
        ],
        "typeVersion": 1.1,
        "disabled": true
      },
      {
        "parameters": {
          "content": "### Pseudo-Synchronously Wait for All Sub-Workflows to finish",
          "height": 80,
          "width": 283,
          "color": 3
        },
        "id": "3fc5a382-5cdd-4559-bdd3-b37073d26d50",
        "name": "Sticky Note1",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          3440,
          592
        ],
        "typeVersion": 1,
        "disabled": true
      },
      {
        "parameters": {},
        "id": "0f6a8b67-bd1b-40bc-80d5-b7378ce5b57c",
        "name": "Continue Workflow (noop)",
        "type": "n8n-nodes-base.noOp",
        "position": [
          7040,
          352
        ],
        "typeVersion": 1,
        "disabled": true
      },
      {
        "parameters": {
          "jsCode": "const inputData = $('Load Drill Queries').first().json;\n  const systemFields = ['headers', 'params', 'query', 'webhookUrl', 'executionMode'];\n  const drillQueries = {};\n\n  for (const [key, value] of Object.entries(inputData)) {\n    if (!systemFields.includes(key) && typeof value === 'object' && Array.isArray(value)) {\n      drillQueries[key] = value;\n    }\n  }\n\n  const uuidKeys = Object.keys(drillQueries);\n\n  if (uuidKeys.length === 0) {\n    return [{\n      json: {\n        error: 'No drill query UUIDs found in input data',\n        inputKeys: Object.keys(inputData)\n      }\n    }];\n  }\n\n  let count = 0;\n  uuidKeys.forEach(uuid => count += drillQueries[uuid].length);\n\n  return {\n    \"drill_queries_count\": count\n  };"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2352,
          1120
        ],
        "id": "347e89ad-1d53-4099-8d9d-20a8602b2c12",
        "name": "Get Drill Queries Count"
      },
      {
        "parameters": {
          "amount": 0.4
        },
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          7168,
          1760
        ],
        "id": "75631430-add9-4385-b26e-6c83f12f04e6",
        "name": "Wait",
        "webhookId": "722519d8-a165-4f2b-a0fc-24915e959db5",
        "disabled": true
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n  \"today\": \"2026-02-22\",\n  \"current_fiscal_quarter\": \"FY2027 Q1\",\n  \"previous_fiscal_quarter\": \"FY2026 Q4\",\n  \"current_fiscal_half\": \"FY2027 H1\",\n  \"previous_fiscal_half\": \"FY2026 H2\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          1296,
          1328
        ],
        "id": "0f55f706-a159-4c68-bb74-68f7dbe15efe",
        "name": "Structured Output Parser"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=<role>\nYou are a date-aware automation agent that, at runtime, uses the current calendar date and converts it into the organization’s fiscal quarter and fiscal half-year.\n</role>\n\n<task>\n1. Capture today’s date in ISO-8601 format (YYYY-MM-DD).  \n2. Derive the current fiscal quarter using this mapping:  \n   • February, March, April → Q1  \n   • May, June, July → Q2  \n   • August, September, October → Q3  \n   • November, December, January → Q4\n3. Similarly, derive the previous fiscal quarter.\n4. Then, derive the previous' previous fiscal quarter. In the end, you will have 3 fiscal quarters. From here on out, you will consider the \"current_fiscal_quarter\" to be your derived previous fiscal quarter and you will consider the \"previous_fiscal_quarter\" to be your derived 2 quarters previous. This is because we will run this at the end of each quarter that has just finished in order to compare this most recently finished fiscal quarter with 2 quarters ago.\n4. Determine the current fiscal half-year: \n   • H1 = Q1 + Q2 (February – July) \n   • H2 = Q3 + Q4 (August – January)\n5. Similarly to deriving the current fiscal half-year, derive the previous fiscal half-year\n6. Assign the fiscal year (FY):  \n   • FY is labelled by the calendar year of the January that closes Q4.  \n     – Example: any date from 2025-11-01 through 2026-01-31 belongs to FY2026 Q4.  \n7. If a month is ever missing from the mapping (unexpected), set  \n   \"fiscal_quarter\": \"Unmapped\", \"fiscal_half\": \"Unmapped\",  \n   add a \"warning\" key explaining why, and continue.  \n8. Produce one JSON object that follows the output_format section exactly.  \n9. Self-check: validate JSON syntax, confirm quarter/half/year logic, and flag any ambiguity or edge case before returning.\n</task>\n\n<context>\nThe organization follows a non-standard fiscal calendar that begins in February and spans ten active months, grouping them into the quarters above.  \nWe prefer the simplest workflow that fully handles edge cases (e.g., leap years, timezone differences, cross-year FY labelling) and follows security-best practices.\n</context>\n\n<examples>\n<fiscal_quarter_examples>\n2024-02-01 → FY2025 Q1  \n2024-05-15 → FY2025 Q2\n2024-07-29 → FY2025 Q2\n2024-08-01 → FY2025 Q3\n2024-10-30 → FY2025 Q3\n2024-12-30 → FY2025 Q4  \n2025-01-31 → FY2025 Q4\n2025-02-01 → FY2026 Q1\n2025-06-10 → FY2026 Q2  \n2025-09-05 → FY2026 Q3  \n2025-12-12 → FY2026 Q4  \n2026-03-03 → FY2027 Q1\n2026-05-22 → FY2027 Q2\n</fiscal_quarter_examples>\n\n<fiscal_half_examples>\n2024-02-01 → FY2025 H1\n2024-05-15 → FY2025 H1\n2024-07-29 → FY2025 H1\n2024-08-01 → FY2025 H2\n2024-10-30 → FY2025 H2\n2024-12-30 → FY2025 H2  \n2025-01-31 → FY2025 H2  \n2025-02-01 → FY2026 H1\n2025-06-10 → FY2026 H1  \n2025-09-05 → FY2026 H2  \n2025-12-12 → FY2026 H2  \n2026-03-03 → FY2027 H1\n2026-05-22 → FY2027 H1\n</fiscal_half_examples>\n\n</examples>\n\n<guidelines>\n- Output only the JSON object—no extra text.  \n- Keys must be lower_snake_case and wrapped in double quotes.  \n- Do not include trailing commas.  \n- Point out any implicit or non-obvious “gotchas” (e.g., FY roll-over rules) in the \"warning\" field instead of silently proceeding.  \n- Do not simply agree; highlight anything incorrect or sub-optimal and suggest improvements.  \n- Think step-by-step, then self-check that the response meets every instruction before returning it.\n</guidelines>\n\n<input>\ntoday: {{ $today.format('yyyy-MM-dd') }}\n</input>\n\n<output_format>\n{\n  \"today\": \"2026-05-22\",\n  \"current_fiscal_quarter\": \"FY2027 Q1\",\n  \"previous_fiscal_quarter\": \"FY2026 Q4\",\n  \"current_fiscal_half\": \"FY2027 H1\",\n  \"previous_fiscal_half\": \"FY2026 H2\"\n}\n</output_format>",
          "hasOutputParser": true,
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3,
        "position": [
          1136,
          1120
        ],
        "id": "627f6fd7-713f-44fe-8a43-511b655cf548",
        "name": "Fiscal Quarter Extractor"
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n\t\"current_fiscal_quarter_query\": {\n  \n},\n\t\"previous_fiscal_quarter_query\": {\n  \n}\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          4096,
          2656
        ],
        "id": "5d7f57ba-6e3f-488c-aaac-d6db6eca7df4",
        "name": "Structured Output Parser1",
        "disabled": true
      },
      {
        "parameters": {
          "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  let output = JSON.parse(item.json.output);\n\n  if (\"current_fiscal_quarter_query\" in output) {\n    item.json.current_fiscal_quarter_query = output.current_fiscal_quarter_query;\n  }\n\n  if (\"previous_fiscal_quarter_query\" in output) {\n    item.json.previous_fiscal_quarter_query = output.previous_fiscal_quarter_query;\n  }\n  \n  if (\"query\" in output) {\n    item.json.query = output.query;\n  }\n\n  delete item.json.output;\n}\n\nreturn $input.all();"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4512,
          2448
        ],
        "id": "39eee60c-2b5f-4c2c-8082-d9b95868ed89",
        "name": "Parse Modified Query AI Output",
        "disabled": true
      },
      {
        "parameters": {
          "model": "o4-mini",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
        "typeVersion": 1,
        "position": [
          1120,
          1328
        ],
        "id": "5421085b-5efc-40de-895d-5f9d003d2ddf",
        "name": "o4-mini",
        "credentials": {
          "azureOpenAiApi": {
            "id": "N96DE6AiByL8h8kA",
            "name": "Azure OpenAI o4-mini"
          }
        }
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "={\n  \"document_query_id\": \"{{ $('Loop Query Item').item.json.document_query_id }}\",\n  \"document_query_name\": \"{{ $('Loop Query Item').item.json.document_query_name }}\",\n  \"drill_name\": \"{{ $('Loop Over Queries').item.json.drill_name }}\",\n  \"current_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').first().json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').first().json.output.previous_fiscal_quarter }}\",\n  \"current_fiscal_half\": \"{{ $('Fiscal Quarter Extractor').first().json.output.current_fiscal_half }}\",\n  \"previous_fiscal_half\": \"{{ $('Fiscal Quarter Extractor').first().json.output.previous_fiscal_half }}\",\n  \"user_id\": \"{{ $('Global Vars').first().json.default_user_id }}\",\n  \"current_fiscal_quarter_query\": {{ $('Parse Modified Query AI Output1').item.json.current_fiscal_quarter_query || {} }},\n  \"previous_fiscal_quarter_query\": {{ $('Parse Modified Query AI Output1').item.json.previous_fiscal_quarter_query || {} }},\n  \"google_document_id\": \"{{ $('Create Takeaways Doc').item.json.id }}\"\n\n}\n\n\n\n",
          "includeOtherFields": true,
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6016,
          1696
        ],
        "id": "b62a9170-658d-4907-9592-d33d8e748f5a",
        "name": "Create Request Payload"
      },
      {
        "parameters": {
          "content": "<role>\nYou are a JSON-transformation agent who edits BI-tool query objects for fiscal quarter comparisons with automatic sorting.\n</role>\n\n<task>\nGoal: Produce two modified copies of the supplied query JSON with numeric measure sorts added and fiscal quarter filters updated.\n\nPlan of action (follow sequentially):\n1. Parse the input JSON exactly as received; preserve every field order and value.\n2. **Add Sorts**: Identify numeric measures in the \"fields\" array and add them to the \"sorts\" array.\n3. **Locate Filter**: Find the first object inside \"filters\" whose inner field \"kind\" equals \"TIME_FOR_UNIT_DURATION\" (case-sensitive).\n4. **Duplicate Query**: Create two copies of the modified query:\n   a. In Copy 1, replace that filter object's \"left_side\" value with the provided {current_fiscal_quarter}.\n   b. In Copy 1, replace the numeric value in \"limit\" to 200.\n   c. In Copy 2, replace that same \"left_side\" value with the provided {previous_fiscal_quarter}.\n   d. In Copy 2, replace the numeric value in \"limit\" to 200.\n5. **Return**: A JSON object with the structured output format containing the two edited query objects for keys: current_fiscal_quarter_query and previous_fiscal_quarter_query.\n</task>\n\n<context>\nYou will receive:\n• A complete JSON object named \"query\" following Omni analytics query structure\n• Two strings:\n  – current_fiscal_quarter\n  – previous_fiscal_quarter\n\nThe query object contains these key fields:\n- **fields**: Array of column names to SELECT and display (format: \"schema__table.field_name\")\n- **sorts**: Array of sort configuration objects (you will modify this)\n- **filters**: Object containing WHERE clause conditions\n- **limit**: Numeric value for row limit (you will set this to 200)\n- **table**: String reference to the data table\n- **modelId**: Omni model identifier (UUID)\n- **version**: Query schema version\n- **Other fields**: pivots, calculations, etc. (preserve unchanged)\n\nModify **ONLY** the \"sorts\" array, the \"left_side\" value of the TIME_FOR_UNIT_DURATION filter, and the \"limit\" value. All other content must remain bit-for-bit identical, including whitespace and ordering. We prefer the simplest workflow that fully handles edge cases and follows security-best practices.\n</context>\n\n<numeric_measure_identification>\n<step_1>\n<description>\nIdentify Numeric Measures in Fields Array\n\nScan the \"fields\" array and identify numeric measures using these patterns:\n</description>\n\n<inclusion_patterns>\nInclusion Patterns (these ARE numeric measures):\n- `total_*` → e.g., total_ending_arr, total_customers, total_new_arr\n- `*_arr` → e.g., new_arr, upsell_arr, churn_arr, downsell_arr\n- `*_sum` → e.g., revenue_sum, new_arr_sum\n- `*_count` → e.g., opportunity_count, customer_count\n- `*_max`, `*_min` → e.g., lake_gbs_customer_data_max, min_date\n- `*_avg`, `*_average`, `*_mean` → e.g., avg_deal_size, mean_time_to_close\n- `*_gb`, `*_tb`, `*_bytes` → e.g., total_cloud_stream_in_gb_30d, total_edge_in_bytes\n- `*_nodes`, `*_instances` → e.g., total_edge_nodes, cloud_edge_nodes_30d\n- `*_percentage`, `*_percent`, `*_rate`, `*_ratio` → percentage/ratio metrics\n- `*_revenue`, `*_bookings`, `*_billings` → financial metrics\n- `*_headcount`, `*_employees`, `*_users` → when aggregated\n- `*_derived` → e.g., new_arr_derived, calculated_revenue_derived\n- `cumulative_*` → e.g., cumulative_revenue\n- `max_*`, `min_*` → e.g., max_edge_nodes, min_starting_arr\n</inclusion_patterns>\n\n<exclusion_patterns>\nExclusion Patterns (these are NOT numeric measures - they're dimensions):\n- `*_name`, `*_title` → e.g., customer_name, account_name, owner_name\n- `*_id` → e.g., cribl_id, org_id, opportunity_id (identifiers are dimensions)\n- `*_date`, `*_time`, `*_timestamp` → e.g., close_date, created_at\n- `*_type`, `*_category`, `*_status` → e.g., customer_type, stage_name\n- `*_description`, `*_notes` → text descriptions\n- `is_*`, `has_*` → e.g., is_last_day_of_fq, is_active (boolean flags)\n- Fields with `[transformations]` → e.g., fiscal_quarter[fiscal_quarter], first_purchase_quarter[date]\n- `owner_*`, `created_by_*`, `updated_by_*` → user references\n- `*_key` → lookup keys\n</exclusion_patterns>\n\n<pattern_matching_rules>\nPattern Matching Rules (Regex):\n```\nINCLUDE if field name matches ANY of:\n  - ^.*total_.*$              (contains \"total_\")\n  - ^.*_arr$                  (ends with \"_arr\")\n  - ^.*_sum$                  (ends with \"_sum\")\n  - ^.*_count$                (ends with \"_count\")\n  - ^.*_max$                  (ends with \"_max\")\n  - ^.*_min$                  (ends with \"_min\")\n  - ^.*_avg$|^.*_mean$        (ends with \"_avg\" or \"_mean\")\n  - ^.*_gb.*$|^.*_bytes.*$    (contains \"_gb\" or \"_bytes\")\n  - ^.*_nodes.*$              (contains \"_nodes\")\n  - ^.*_derived$              (ends with \"_derived\")\n  - ^max_.*$|^min_.*$         (starts with \"max_\" or \"min_\")\n  - ^cumulative_.*$           (starts with \"cumulative_\")\n\nEXCLUDE if field name matches ANY of:\n  - ^.*_name$|^.*_title$      (ends with \"_name\" or \"_title\")\n  - ^.*_id$                   (ends with \"_id\")\n  - ^.*date.*$|^.*quarter.*$  (contains \"date\" or \"quarter\")\n  - ^.*_at$                   (ends with \"_at\")\n  - ^.*_type$|^.*_status$     (ends with \"_type\" or \"_status\")\n  - ^.*_stage$                (ends with \"_stage\")\n  - ^is_.*$|^has_.*$          (starts with \"is_\" or \"has_\")\n  - ^.*\\[.*\\]$                (contains brackets)\n```\n</pattern_matching_rules>\n\n<example_field_analysis>\nExample Field Analysis:\n- `finance__customer_quarterly_arr.total_customers` → ✅ NUMERIC MEASURE (matches `total_*`)\n- `finance__customer_quarterly_arr.customer_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.total_arr` → ✅ NUMERIC MEASURE (matches `total_*` and `*_arr`)\n- `finance__customer_quarterly_arr.fiscal_quarter_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.new_arr_sum` → ✅ NUMERIC MEASURE (matches `*_sum`)\n- `finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]` → ❌ DIMENSION (has brackets)\n</example_field_analysis>\n</step_1>\n</numeric_measure_identification>\n\n<sort_object_creation>\n<step_2>\n<description>\nCreate Sort Objects for Numeric Measures\n\nFor each identified numeric measure, create a sort object with this structure:\n\n```json\n{\n  \"column_name\": \"schema__table.field_name\",\n  \"sort_descending\": true\n}\n```\n</description>\n\n<field_definitions>\nField Definitions:\n- **column_name** (required, string): The exact field reference from the fields array\n- **sort_descending** (required, boolean): Set to `true` for descending sort (largest values first)\n</field_definitions>\n\n<sort_direction_guidelines>\nSort Direction Guidelines:\n- Numeric measures: Use `true` (descending) to show largest values first\n- This is the standard for BI tools to show \"top performers\" or \"highest values\"\n</sort_direction_guidelines>\n\n<deduplication>\nDeduplication:\nIf the \"sorts\" array already has items, check before adding:\n- If a sort object already exists for a given `column_name`, skip it\n- Append new sort objects only for measures not already in sorts\n- Preserve existing sort objects in their original order\n</deduplication>\n\n<example>\nExample:\nInput fields:\n```json\n[\n  \"finance__customer_quarterly_arr.customer_name\",\n  \"finance__customer_quarterly_arr.total_ending_arr\",\n  \"finance__customer_quarterly_arr.total_new_arr\"\n]\n```\n\nCreated sort objects:\n```json\n[\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_ending_arr\",\n    \"sort_descending\": true\n  },\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_new_arr\",\n    \"sort_descending\": true\n  }\n]\n```\n\nNote: `customer_name` is excluded because it ends with `_name` (dimension, not measure).\n</example>\n</step_2>\n</sort_object_creation>\n\n<query_modification>\n<step_3>\n<description>\nModify Query Object - Add Sorts\n\nAdd the created sort objects to the \"sorts\" array in the query object.\n</description>\n\n<before_adding_sorts>\nBefore Adding Sorts:\n```json\n{\n  \"sorts\": [],\n  \"fields\": [\n    \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n    \"finance__customer_quarterly_arr.total_customers\",\n    \"finance__customer_quarterly_arr.total_arr\"\n  ]\n}\n```\n</before_adding_sorts>\n\n<after_adding_sorts>\nAfter Adding Sorts:\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n      \"sort_descending\": true\n    },\n    {\n      \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n      \"sort_descending\": true\n    }\n  ],\n  \"fields\": [\n    \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n    \"finance__customer_quarterly_arr.total_customers\",\n    \"finance__customer_quarterly_arr.total_arr\"\n  ]\n}\n```\n</after_adding_sorts>\n</step_3>\n</query_modification>\n\n<fiscal_quarter_modification>\n<step_4>\n<description>\nModify Fiscal Quarter Filter and Limit\n\nAfter adding sorts, locate and modify the TIME_FOR_UNIT_DURATION filter:\n\n1. Find the first filter object where `\"kind\": \"TIME_FOR_UNIT_DURATION\"`\n2. Note the current \"left_side\" value\n3. Prepare to create two copies with different left_side values\n</description>\n\n<filter_structure>\nFilter Structure:\n```json\n{\n  \"type\": \"date\",\n  \"kind\": \"TIME_FOR_UNIT_DURATION\",\n  \"left_side\": \"FY2026 Q1\",\n  \"right_side\": {\n    \"unit\": \"fiscal_quarter\",\n    \"count\": 1\n  }\n}\n```\n</filter_structure>\n\n<modifications_for_each_copy>\nModifications for Each Copy:\n- **Copy 1 (current_fiscal_quarter_query)**:\n  - Set `left_side` to {current_fiscal_quarter}\n  - Set `limit` to 200\n- **Copy 2 (previous_fiscal_quarter_query)**:\n  - Set `left_side` to {previous_fiscal_quarter}\n  - Set `limit` to 200\n</modifications_for_each_copy>\n</step_4>\n</fiscal_quarter_modification>\n\n<examples>\n<complete_example>\n<input>\n```json\n{\n  \"query\": {\n    \"limit\": 1000,\n    \"sorts\": [],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q1\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  },\n  \"current_fiscal_quarter\": \"FY2026 Q2\",\n  \"previous_fiscal_quarter\": \"FY2026 Q1\"\n}\n```\n</input>\n\n<processing_steps>\nProcessing Steps:\n\n**Step 1: Identify numeric measures**\n- ❌ `fiscal_quarter_name` → ends with `_name` (dimension)\n- ✅ `total_customers` → matches `total_*` (measure)\n- ✅ `total_arr` → matches `total_*` and `*_arr` (measure)\n\n**Step 2: Create sort objects**\n```json\n[\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n    \"sort_descending\": true\n  },\n  {\n    \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n    \"sort_descending\": true\n  }\n]\n```\n\n**Step 3: Add sorts to query**\n\n**Step 4: Find TIME_FOR_UNIT_DURATION filter and prepare for duplication**\n\n**Step 5: Create two copies with modified values**\n</processing_steps>\n\n<expected_output>\n```json\n{\n  \"current_fiscal_quarter_query\": {\n    \"limit\": 200,\n    \"sorts\": [\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n        \"sort_descending\": true\n      },\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n        \"sort_descending\": true\n      }\n    ],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q2\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  },\n  \"previous_fiscal_quarter_query\": {\n    \"limit\": 200,\n    \"sorts\": [\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n        \"sort_descending\": true\n      },\n      {\n        \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n        \"sort_descending\": true\n      }\n    ],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q1\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  }\n}\n```\n</expected_output>\n</complete_example>\n</examples>\n\n<input>\n{\n  \"query\": {{ $json.query.toJsonString() }},\n  \"current_fiscal_quarter\": \"{{  $('Fiscal Quarter Extractor').item.json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').item.json.output.previous_fiscal_quarter }}\"\n}\n</input>\n\n<edge_cases>\n<description>\nEdge Cases to Handle\n</description>\n\n<case_1>\n1. Query with existing sorts:\n- Append new sort objects to the existing sorts array\n- Preserve the order of existing sorts\n- Do not create duplicate sort objects for fields already in sorts\n\n**Example Input:**\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"sales__opportunity.new_arr_derived\",\n      \"sort_descending\": true\n    }\n  ],\n  \"fields\": [\n    \"sales__opportunity.account_name\",\n    \"sales__opportunity.new_arr_derived\",\n    \"sales__opportunity.total_arr\"\n  ]\n}\n```\n\n**Processing:**\n- `new_arr_derived` already has a sort → skip\n- `total_arr` does not have a sort → add\n\n**Result:**\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"sales__opportunity.new_arr_derived\",\n      \"sort_descending\": true\n    },\n    {\n      \"column_name\": \"sales__opportunity.total_arr\",\n      \"sort_descending\": true\n    }\n  ]\n}\n```\n</case_1>\n\n<case_2>\n2. Query with no numeric measures:\n- Return the query with only fiscal quarter and limit modifications\n- The sorts array remains as-is (empty or with existing sorts)\n\n**Example:**\n```json\n{\n  \"fields\": [\n    \"sales__accounts.account_name\",\n    \"sales__accounts.owner_name\",\n    \"sales__opportunity.close_date\"\n  ],\n  \"sorts\": []\n}\n```\n\n**Result:** Sorts array stays empty `[]`\n</case_2>\n\n<case_3>\n3. Query with mixed numeric and dimension fields:\n- Only add sorts for true numeric measures\n- Skip all dimension fields even if they contain numbers in their values\n</case_3>\n\n<case_4>\n4. Multiple TIME_FOR_UNIT_DURATION filters:\n- Only modify the FIRST occurrence\n- Leave other TIME_* filters unchanged\n</case_4>\n\n<case_5>\n5. Missing TIME_FOR_UNIT_DURATION filter:\n- Return error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n</case_5>\n\n<case_6>\n6. Malformed JSON:\n- Return error object: `{\"error\": \"Invalid JSON structure\", \"details\": \"<specific issue>\"}`\n</case_6>\n</edge_cases>\n\n<guidelines>\n<description>\nProcessing Guidelines\n</description>\n\n- Preserve JSON formatting exactly; do not pretty-print or minify.\n- Apply sorts modification BEFORE duplicating the query.\n- Do not alter any filters except the first TIME_FOR_UNIT_DURATION filter's left_side value.\n- If no matching TIME_FOR_UNIT_DURATION filter exists, return an error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n- Point out any ambiguities or missing data instead of guessing.\n- Do not simply agree with assumptions; highlight logical or data issues and propose corrections.\n- Mention tricky edge cases when they occur.\n- Output only valid JSON or an error object - no commentary, preamble, or markdown formatting.\n- Ensure both output queries have identical sorts arrays (derived from the original query's fields).\n- Set limit to exactly 200 in both output queries.\n- Both queries should be complete, valid Omni query objects.\n</guidelines>\n\n<output_format>\n<description>\nExpected Output Structure\n</description>\n\n```json\n{\n  \"current_fiscal_quarter_query\": {\n    /* Complete query object with:\n       - sorts: array with numeric measure sorts\n       - limit: 200\n       - filters: TIME_FOR_UNIT_DURATION.left_side = current_fiscal_quarter\n       - all other fields: unchanged\n    */\n  },\n  \"previous_fiscal_quarter_query\": {\n    /* Complete query object with:\n       - sorts: array with numeric measure sorts (same as current)\n       - limit: 200\n       - filters: TIME_FOR_UNIT_DURATION.left_side = previous_fiscal_quarter\n       - all other fields: unchanged\n    */\n  }\n}\n```\n\nIf there's an error:\n```json\n{\n  \"error\": \"Error description\",\n  \"details\": \"Specific issue details\"\n}\n```\n</output_format>\n\n<validation_checklist>\n<description>\nValidation Before Returning\n\nVerify the following before returning the result:\n</description>\n\n- [ ] All numeric measures from \"fields\" are in \"sorts\" (no duplicates)\n- [ ] No dimension fields (names, IDs, dates) are in \"sorts\"\n- [ ] All sort objects have both \"column_name\" and \"sort_descending\" fields\n- [ ] All \"sort_descending\" values are `true`\n- [ ] Both queries have \"limit\" set to 200\n- [ ] Current query has correct current_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Previous query has correct previous_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Both queries have identical \"sorts\" arrays\n- [ ] All other fields (table, modelId, version, etc.) are preserved unchanged\n- [ ] The output is valid JSON with no syntax errors\n- [ ] Output contains exactly two keys: \"current_fiscal_quarter_query\" and \"previous_fiscal_quarter_query\"\n</validation_checklist>\n"
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          5104,
          1296
        ],
        "typeVersion": 1,
        "id": "7ef40ecd-556e-48e1-addd-d5b437cee372",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "schemaType": "manual",
          "inputSchema": "{\n    \"type\": \"object\",\n    \"properties\": {\n      \"limit\": {\n        \"type\": \"number\",\n        \"description\": \"Maximum number of rows to return\"\n      },\n      \"sorts\": {\n        \"type\": \"array\",\n        \"description\": \"Array of sort configuration objects\",\n        \"items\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"column_name\": {\n              \"type\": \"string\",\n              \"description\": \"Full field name to sort by (must exist in fields array)\"\n            },\n            \"sort_descending\": {\n              \"type\": \"boolean\",\n              \"description\": \"true for descending (highest first), false for ascending\"\n            },\n            \"null_sort\": {\n              \"type\": \"string\",\n              \"description\": \"Optional: How to handle NULL values (OMNI_DEFAULT, NULLS_FIRST, NULLS_LAST)\",\n              \"enum\": [\"OMNI_DEFAULT\", \"NULLS_FIRST\", \"NULLS_LAST\"]\n            },\n            \"is_column_sort\": {\n              \"type\": \"boolean\",\n              \"description\": \"Optional: Whether this is a column-based sort vs aggregation sort\"\n            }\n          },\n          \"required\": [\"column_name\", \"sort_descending\"]\n        }\n      },\n      \"table\": {\n        \"type\": \"string\",\n        \"description\": \"The primary table/view to query (format: schema__table)\"\n      },\n      \"fields\": {\n        \"type\": \"array\",\n        \"description\": \"List of column names to SELECT\",\n        \"items\": {\n          \"type\": \"string\"\n        }\n      },\n      \"pivots\": {\n        \"type\": \"array\",\n        \"description\": \"Pivot table configuration\"\n      },\n      \"dbtMode\": {\n        \"type\": \"boolean\",\n        \"description\": \"Whether to use dbt model directly\"\n      },\n      \"filters\": {\n        \"type\": \"object\",\n        \"description\": \"WHERE clause conditions\"\n      },\n      \"modelId\": {\n        \"type\": \"string\",\n        \"description\": \"Omni model identifier (UUID format)\"\n      },\n      \"version\": {\n        \"type\": \"number\",\n        \"description\": \"Query schema version\"\n      },\n      \"controls\": {\n        \"type\": \"array\",\n        \"description\": \"Dashboard filter controls\"\n      },\n      \"rewriteSql\": {\n        \"type\": \"boolean\",\n        \"description\": \"Allow SQL rewriting for optimization\"\n      },\n      \"row_totals\": {\n        \"type\": \"object\",\n        \"description\": \"Row totaling configuration\"\n      },\n      \"fill_fields\": {\n        \"type\": \"array\",\n        \"description\": \"Fields to fill with default values\"\n      },\n      \"calculations\": {\n        \"type\": \"array\",\n        \"description\": \"Custom calculated fields\"\n      },\n      \"column_limit\": {\n        \"type\": \"number\",\n        \"description\": \"Maximum columns to return\"\n      },\n      \"join_via_map\": {\n        \"type\": \"object\",\n        \"description\": \"Custom join configurations\"\n      },\n      \"column_totals\": {\n        \"type\": \"object\",\n        \"description\": \"Column totaling configuration\"\n      },\n      \"userEditedSQL\": {\n        \"type\": \"string\",\n        \"description\": \"User-overridden SQL\"\n      },\n      \"dimensionIndex\": {\n        \"type\": \"number\",\n        \"description\": \"Dimension ordering\"\n      },\n      \"default_group_by\": {\n        \"type\": \"boolean\",\n        \"description\": \"Use default grouping\"\n      },\n      \"custom_summary_types\": {\n        \"type\": \"object\",\n        \"description\": \"Custom aggregation types\"\n      },\n      \"join_paths_from_topic_name\": {\n        \"type\": \"string\",\n        \"description\": \"Topic/model name for joins\"\n      }\n    },\n    \"required\": [\n      \"limit\",\n      \"sorts\",\n      \"table\",\n      \"fields\",\n      \"pivots\",\n      \"dbtMode\",\n      \"filters\",\n      \"modelId\",\n      \"version\",\n      \"controls\",\n      \"rewriteSql\",\n      \"row_totals\",\n      \"fill_fields\",\n      \"calculations\",\n      \"column_limit\",\n      \"join_via_map\",\n      \"column_totals\",\n      \"userEditedSQL\",\n      \"dimensionIndex\",\n      \"default_group_by\",\n      \"custom_summary_types\",\n      \"join_paths_from_topic_name\"\n    ]\n  }"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          4864,
          1744
        ],
        "id": "5abcf832-7ccf-4c94-a988-237be2d39bec",
        "name": "Structured Output Parser2"
      },
      {
        "parameters": {
          "jsCode": "\n// for (const item of $input.all()) {\n//   let output = JSON.parse(item.json.output);\n\n//   if (\"current_fiscal_quarter_query\" in output) {\n//     item.json.current_fiscal_quarter_query = output.current_fiscal_quarter_query;\n//   }\n\n//   if (\"previous_fiscal_quarter_query\" in output) {\n//     item.json.previous_fiscal_quarter_query = output.previous_fiscal_quarter_query;\n//   }\n  \n//   if (\"query\" in output) {\n//     item.json.query = output.query;\n//   }\n\n//   delete item.json.output;\n// }\n\n// return $input.all();\n\n\nconst results = [];\n\nfor (const item of $input.all()) {\n  let output = JSON.parse(item.json.output);\n\n  // Handle the new array format\n  if (Array.isArray(output)) {\n    // Each element in the array is a query pair for a single measure\n    for (const queryPair of output) {\n      const newItem = {\n        json: {\n          ...item.json,\n          sorted_by_measure: queryPair.sorted_by_measure,\n          current_fiscal_quarter_query: queryPair.current_fiscal_quarter_query,\n          previous_fiscal_quarter_query: queryPair.previous_fiscal_quarter_query\n        }\n      };\n      delete newItem.json.output;\n      results.push(newItem);\n    }\n  }\n  // Backwards compatibility: handle old object format\n  else if (typeof output === 'object' && output !== null) {\n    if (\"current_fiscal_quarter_query\" in output) {\n      item.json.current_fiscal_quarter_query = output.current_fiscal_quarter_query;\n    }\n    if (\"previous_fiscal_quarter_query\" in output) {\n      item.json.previous_fiscal_quarter_query = output.previous_fiscal_quarter_query;\n    }\n    if (\"query\" in output) {\n      item.json.query = output.query;\n    }\n    if (\"error\" in output) {\n      item.json.error = output.error;\n      item.json.details = output.details;\n    }\n    delete item.json.output;\n    results.push(item);\n  }\n}\n\nreturn results;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5600,
          1504
        ],
        "id": "e17ce027-26fc-465a-87d1-098a4fd7e0b0",
        "name": "Parse Modified Query AI Output1"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=<role>\nYou are a JSON-transformation agent who edits BI-tool query objects.\n</role>\n\n<task>\nGoal: Produce two modified copies of the supplied query JSON.\n\nPlan of action (follow sequentially):\n1. Parse the input JSON exactly as received; preserve every field order and value.\n2. Locate the first object inside \"filters\" whose inner field \"kind\" equals \"TIME_FOR_UNIT_DURATION\" (case-sensitive).\n3. Duplicate the entire query twice:\n   a. In Copy 1, replace that object’s \"left_side\" value with the provided {current_fiscal_quarter}.\n   b. In Copy 1, replace the numeric value in limit to 200 .\n   c. In Copy 2, replace that same \"left_side\" value with the provided {previous_fiscal_quarter} .\n   d. In Copy 2, replace the numeric value in limit to 200 .\n4. Return a json object with the structured output in the format of output_format with the two edited JSON objects in the for each key: current_fiscal_quarter_query and previous_fiscal_quarter_query\n</task>\n\n<context>\nYou will receive:\n• A complete JSON object named query.\n• Two strings: \n  – current_fiscal_quarter  \n  – previous_fiscal_quarter  \n\nReplace **ONLY** the \"left_side\" value of the filter having \"kind\": \"TIME_FOR_UNIT_DURATION\" and the numeric value for limit. All other content must remain bit-for-bit identical, including whitespace and ordering.  We prefer the simplest workflow that fully handles edge cases and follows security-best practices.\n</context>\n\n<examples>\nInput:\n\n```json\n{\n  \"query\": { ...original JSON... },\n  \"current_fiscal_quarter\": \"FY2026 Q2\",\n  \"previous_fiscal_quarter\": \"FY2026 Q1\"\n}\n\n```\n\nExpected high-level output (schema only):\n\n```json\n{\n  \"current_fiscal_quarter_query\": { /* query with FY2026 Q2 in left_side */ },\n  \"previous_fiscal_quarter_query\": { /* query with FY2026 Q1 in left_side */ }\n}\n```\n</examples>\n\n<input>\n{\n  \"query\": {{ $json.query.toJsonString() }},\n  \"current_fiscal_quarter\": \"{{  $('Fiscal Quarter Extractor').item.json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').item.json.output.previous_fiscal_quarter }}\"\n}\n</input>\n\n<guidelines>\n- Preserve JSON formatting exactly; do not pretty-print or minify.\n- Do not alter any other filters, even if they also contain TIME_* kinds.\n- If no matching filter exists, return an error object explaining “TIME_FOR_UNIT_DURATION filter not found”.\n- Point out any ambiguities or missing data instead of guessing.\n- Do not simply agree; highlight logical or data issues and propose corrections.\n- Mention tricky edge cases (e.g., multiple TIME_FOR_UNIT_DURATION filters, malformed JSON).\n- Output only valid JSON or an error object - no commentary, nor preamble.\n</guidelines>\n",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3,
        "position": [
          3920,
          2448
        ],
        "id": "3a3a4333-4773-44f9-8d18-103b318fbe67",
        "name": "OLD Query JSON Modifier",
        "disabled": true
      },
      {
        "parameters": {
          "model": "gpt-5-mini",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
        "typeVersion": 1,
        "position": [
          3904,
          2640
        ],
        "id": "0b5d49f3-9f62-4323-93f5-bf49acbe8642",
        "name": "OLD gpt-5-mini",
        "credentials": {
          "azureOpenAiApi": {
            "id": "ljEp6Un527XmKGRN",
            "name": "Azure OpenAI gpt-5-mini"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "model": "gpt-5-mini",
          "options": {
            "timeout": 360000
          }
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
        "typeVersion": 1,
        "position": [
          5104,
          1728
        ],
        "id": "c307facc-4098-4a60-a627-d4538284d845",
        "name": "gpt-5-mini",
        "credentials": {
          "azureOpenAiApi": {
            "id": "ljEp6Un527XmKGRN",
            "name": "Azure OpenAI gpt-5-mini"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=<role>\nYou are a JSON-transformation agent who generates multiple BI-tool query pairs for fiscal quarter comparisons, with each pair sorted by a single numeric measure.\n</role>\n\n<task>\nGoal: Produce an **array of query pairs**, one pair per numeric measure, where each pair contains queries sorted by a single measure with different fiscal quarter filters.\n\nPlan of action (follow sequentially):\n1. Parse the input JSON exactly as received; preserve every field order and value.\n2. **Identify Measures**: Scan the \"fields\" array to identify all numeric measures using the inclusion/exclusion patterns.\n3. **Locate Filter**: Find the first object inside \"filters\" whose inner field \"kind\" equals \"TIME_FOR_UNIT_DURATION\" (case-sensitive).\n4. **Generate Query Pairs**: For each numeric measure identified:\n   a. Create a query pair object with that single measure in the \"sorts\" array.\n   b. For `current_fiscal_quarter_query`: set \"left_side\" to {current_fiscal_quarter} and \"limit\" to 200.\n   c. For `previous_fiscal_quarter_query`: set \"left_side\" to {previous_fiscal_quarter} and \"limit\" to 200.\n   d. Include `sorted_by_measure` metadata field with the measure name.\n5. **Return**: A JSON array where each element is a query pair object containing `sorted_by_measure`, `current_fiscal_quarter_query`, and `previous_fiscal_quarter_query`.\n   </task>\n\n<context>\nYou will receive:\n• A complete JSON object named \"query\" following Omni analytics query structure\n• Two strings:\n  – current_fiscal_quarter\n  – previous_fiscal_quarter\n\nThe query object contains these key fields:\n- **fields**: Array of column names to SELECT and display (format: \"schema__table.field_name\")\n- **sorts**: Array of sort configuration objects (you will modify this)\n- **filters**: Object containing WHERE clause conditions\n- **limit**: Numeric value for row limit (you will set this to 200)\n- **table**: String reference to the data table\n- **modelId**: Omni model identifier (UUID)\n- **version**: Query schema version\n- **Other fields**: pivots, calculations, etc. (preserve unchanged)\n\nModify **ONLY** the \"sorts\" array (replacing it with a single-measure sort), the \"left_side\" value of the TIME_FOR_UNIT_DURATION filter, and the \"limit\" value. All other content must remain bit-for-bit identical, including whitespace and ordering. We prefer the simplest workflow that fully handles edge cases and follows security-best practices.\n</context>\n\n<numeric_measure_identification>\n<step_1>\n<description>\nIdentify Numeric Measures in Fields Array\n\nScan the \"fields\" array and identify numeric measures using these patterns:\n</description>\n\n<inclusion_patterns>\nInclusion Patterns (these ARE numeric measures):\n- `total_*` → e.g., total_ending_arr, total_customers, total_new_arr\n- `*_arr` → e.g., new_arr, upsell_arr, churn_arr, downsell_arr\n- `*_sum` → e.g., revenue_sum, new_arr_sum\n- `*_count` → e.g., opportunity_count, customer_count\n- `*_max`, `*_min` → e.g., lake_gbs_customer_data_max, min_date\n- `*_avg`, `*_average`, `*_mean` → e.g., avg_deal_size, mean_time_to_close\n- `*_gb`, `*_tb`, `*_bytes` → e.g., total_cloud_stream_in_gb_30d, total_edge_in_bytes\n- `*_nodes`, `*_instances` → e.g., total_edge_nodes, cloud_edge_nodes_30d\n- `*_percentage`, `*_percent`, `*_rate`, `*_ratio` → percentage/ratio metrics\n- `*_revenue`, `*_bookings`, `*_billings` → financial metrics\n- `*_headcount`, `*_employees`, `*_users` → when aggregated\n- `*_derived` → e.g., new_arr_derived, calculated_revenue_derived\n- `cumulative_*` → e.g., cumulative_revenue\n- `max_*`, `min_*` → e.g., max_edge_nodes, min_starting_arr\n  </inclusion_patterns>\n\n<exclusion_patterns>\nExclusion Patterns (these are NOT numeric measures - they're dimensions):\n- `*_name`, `*_title` → e.g., customer_name, account_name, owner_name\n- `*_id` → e.g., cribl_id, org_id, opportunity_id (identifiers are dimensions)\n- `*_date`, `*_time`, `*_timestamp` → e.g., close_date, created_at\n- `*_type`, `*_category`, `*_status` → e.g., customer_type, stage_name\n- `*_description`, `*_notes` → text descriptions\n- `is_*`, `has_*` → e.g., is_last_day_of_fq, is_active (boolean flags)\n- Fields with `[transformations]` → e.g., fiscal_quarter[fiscal_quarter], first_purchase_quarter[date]\n- `owner_*`, `created_by_*`, `updated_by_*` → user references\n- `*_key` → lookup keys\n  </exclusion_patterns>\n\n<pattern_matching_rules>\nPattern Matching Rules (Regex):\n```\nINCLUDE if field name matches ANY of:\n  - ^.*total_.*$              (contains \"total_\")\n  - ^.*_arr$                  (ends with \"_arr\")\n  - ^.*_sum$                  (ends with \"_sum\")\n  - ^.*_count$                (ends with \"_count\")\n  - ^.*_max$                  (ends with \"_max\")\n  - ^.*_min$                  (ends with \"_min\")\n  - ^.*_avg$|^.*_mean$        (ends with \"_avg\" or \"_mean\")\n  - ^.*_gb.*$|^.*_bytes.*$    (contains \"_gb\" or \"_bytes\")\n  - ^.*_nodes.*$              (contains \"_nodes\")\n  - ^.*_derived$              (ends with \"_derived\")\n  - ^max_.*$|^min_.*$         (starts with \"max_\" or \"min_\")\n  - ^cumulative_.*$           (starts with \"cumulative_\")\n\nEXCLUDE if field name matches ANY of:\n  - ^.*_name$|^.*_title$      (ends with \"_name\" or \"_title\")\n  - ^.*_id$                   (ends with \"_id\")\n  - ^.*date.*$|^.*quarter.*$  (contains \"date\" or \"quarter\")\n  - ^.*_at$                   (ends with \"_at\")\n  - ^.*_type$|^.*_status$     (ends with \"_type\" or \"_status\")\n  - ^.*_stage$                (ends with \"_stage\")\n  - ^is_.*$|^has_.*$          (starts with \"is_\" or \"has_\")\n  - ^.*\\[.*\\]$                (contains brackets)\n```\n</pattern_matching_rules>\n\n<example_field_analysis>\nExample Field Analysis:\n- `finance__customer_quarterly_arr.total_customers` → ✅ NUMERIC MEASURE (matches `total_*`)\n- `finance__customer_quarterly_arr.customer_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.total_arr` → ✅ NUMERIC MEASURE (matches `total_*` and `*_arr`)\n- `finance__customer_quarterly_arr.fiscal_quarter_name` → ❌ DIMENSION (matches `*_name`)\n- `finance__customer_quarterly_arr.new_arr_sum` → ✅ NUMERIC MEASURE (matches `*_sum`)\n- `finance__customer_quarterly_arr.fiscal_quarter[fiscal_quarter]` → ❌ DIMENSION (has brackets)\n  </example_field_analysis>\n  </step_1>\n  </numeric_measure_identification>\n\n<sort_object_creation>\n<step_2>\n<description>\nIdentify Measures for Individual Query Generation\n\nFor each identified numeric measure, you will create a **separate query pair**. Each query pair will have a single-element \"sorts\" array containing only that measure:\n\n```json\n{\n  \"column_name\": \"schema__table.field_name\",\n  \"sort_descending\": true\n}\n```\n</description>\n\n<field_definitions>\nField Definitions:\n- **column_name** (required, string): The exact field reference from the fields array\n- **sort_descending** (required, boolean): Set to `true` for descending sort (largest values first)\n  </field_definitions>\n\n<sort_direction_guidelines>\nSort Direction Guidelines:\n- Numeric measures: Use `true` (descending) to show largest values first\n- This is the standard for BI tools to show \"top performers\" or \"highest values\"\n  </sort_direction_guidelines>\n\n<one_measure_per_query>\nOne Measure Per Query:\n- Each query pair is sorted by exactly ONE measure\n- If there are N numeric measures, you will generate N query pairs\n- Existing sorts in the input are **replaced entirely** (not appended to)\n- Each query pair's sorts array contains a single sort object\n</one_measure_per_query>\n\n<example>\nExample:\nInput fields:\n```json\n[\n  \"finance__customer_quarterly_arr.customer_name\",\n  \"finance__customer_quarterly_arr.total_ending_arr\",\n  \"finance__customer_quarterly_arr.total_new_arr\"\n]\n```\n\nIdentified numeric measures:\n1. `finance__customer_quarterly_arr.total_ending_arr`\n2. `finance__customer_quarterly_arr.total_new_arr`\n\nThis will result in **2 query pairs**:\n- Query pair 1: sorted by `total_ending_arr` only\n- Query pair 2: sorted by `total_new_arr` only\n\nNote: `customer_name` is excluded because it ends with `_name` (dimension, not measure).\n</example>\n</step_2>\n</sort_object_creation>\n\n<query_modification>\n<step_3>\n<description>\nGenerate Multiple Query Copies - One Per Measure\n\nFor each numeric measure identified, create a separate query pair. Each pair contains two queries (current and previous FQ), both sorted by that single measure.\n</description>\n\n<input_query>\nInput Query:\n```json\n{\n  \"sorts\": [],\n  \"fields\": [\n    \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n    \"finance__customer_quarterly_arr.total_customers\",\n    \"finance__customer_quarterly_arr.total_arr\"\n  ]\n}\n```\n\nNumeric measures identified: `total_customers`, `total_arr` (2 measures)\n</input_query>\n\n<output_query_pairs>\nOutput: Array with 2 query pairs\n\n**Query Pair 1 - Sorted by total_customers:**\n```json\n{\n  \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_customers\",\n  \"current_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_customers\", \"sort_descending\": true }],\n    /* ... rest of query with current FQ filter, limit: 200 */\n  },\n  \"previous_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_customers\", \"sort_descending\": true }],\n    /* ... rest of query with previous FQ filter, limit: 200 */\n  }\n}\n```\n\n**Query Pair 2 - Sorted by total_arr:**\n```json\n{\n  \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_arr\",\n  \"current_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_arr\", \"sort_descending\": true }],\n    /* ... rest of query with current FQ filter, limit: 200 */\n  },\n  \"previous_fiscal_quarter_query\": {\n    \"sorts\": [{ \"column_name\": \"finance__customer_quarterly_arr.total_arr\", \"sort_descending\": true }],\n    /* ... rest of query with previous FQ filter, limit: 200 */\n  }\n}\n```\n</output_query_pairs>\n</step_3>\n</query_modification>\n\n<fiscal_quarter_modification>\n<step_4>\n<description>\nModify Fiscal Quarter Filter and Limit\n\nAfter adding sorts, locate and modify the TIME_FOR_UNIT_DURATION filter:\n\n1. Find the first filter object where `\"kind\": \"TIME_FOR_UNIT_DURATION\"`\n2. Note the current \"left_side\" value\n3. Prepare to create two copies with different left_side values\n   </description>\n\n<filter_structure>\nFilter Structure:\n```json\n{\n  \"type\": \"date\",\n  \"kind\": \"TIME_FOR_UNIT_DURATION\",\n  \"left_side\": \"FY2026 Q1\",\n  \"right_side\": {\n    \"unit\": \"fiscal_quarter\",\n    \"count\": 1\n  }\n}\n```\n</filter_structure>\n\n<modifications_for_each_copy>\nModifications for Each Copy:\n- **Copy 1 (current_fiscal_quarter_query)**:\n   - Set `left_side` to {current_fiscal_quarter}\n   - Set `limit` to 200\n- **Copy 2 (previous_fiscal_quarter_query)**:\n   - Set `left_side` to {previous_fiscal_quarter}\n   - Set `limit` to 200\n     </modifications_for_each_copy>\n     </step_4>\n     </fiscal_quarter_modification>\n\n<examples>\n<complete_example>\n<input>\n```json\n{\n  \"query\": {\n    \"limit\": 1000,\n    \"sorts\": [],\n    \"table\": \"finance__customer_quarterly_arr\",\n    \"fields\": [\n      \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n      \"finance__customer_quarterly_arr.total_customers\",\n      \"finance__customer_quarterly_arr.total_arr\"\n    ],\n    \"filters\": {\n      \"type\": \"composite\",\n      \"operator\": \"and\",\n      \"conditions\": [\n        {\n          \"type\": \"date\",\n          \"kind\": \"TIME_FOR_UNIT_DURATION\",\n          \"left_side\": \"FY2026 Q1\",\n          \"right_side\": {\n            \"unit\": \"fiscal_quarter\",\n            \"count\": 1\n          }\n        }\n      ]\n    },\n    \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n    \"version\": 8\n  },\n  \"current_fiscal_quarter\": \"FY2026 Q2\",\n  \"previous_fiscal_quarter\": \"FY2026 Q1\"\n}\n```\n</input>\n\n<processing_steps>\nProcessing Steps:\n\n**Step 1: Identify numeric measures**\n- ❌ `fiscal_quarter_name` → ends with `_name` (dimension)\n- ✅ `total_customers` → matches `total_*` (measure)\n- ✅ `total_arr` → matches `total_*` and `*_arr` (measure)\n\n**Result:** 2 numeric measures identified → will generate 2 query pairs\n\n**Step 2: Prepare query pairs**\n- Query pair 1: sorted by `total_customers`\n- Query pair 2: sorted by `total_arr`\n\n**Step 3: Find TIME_FOR_UNIT_DURATION filter**\n\n**Step 4: Generate array of query pairs with FQ variations**\n</processing_steps>\n\n<expected_output>\n```json\n[\n  {\n    \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_customers\",\n    \"current_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q2\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    },\n    \"previous_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_customers\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q1\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    }\n  },\n  {\n    \"sorted_by_measure\": \"finance__customer_quarterly_arr.total_arr\",\n    \"current_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q2\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    },\n    \"previous_fiscal_quarter_query\": {\n      \"limit\": 200,\n      \"sorts\": [\n        {\n          \"column_name\": \"finance__customer_quarterly_arr.total_arr\",\n          \"sort_descending\": true\n        }\n      ],\n      \"table\": \"finance__customer_quarterly_arr\",\n      \"fields\": [\n        \"finance__customer_quarterly_arr.fiscal_quarter_name\",\n        \"finance__customer_quarterly_arr.total_customers\",\n        \"finance__customer_quarterly_arr.total_arr\"\n      ],\n      \"filters\": {\n        \"type\": \"composite\",\n        \"operator\": \"and\",\n        \"conditions\": [\n          {\n            \"type\": \"date\",\n            \"kind\": \"TIME_FOR_UNIT_DURATION\",\n            \"left_side\": \"FY2026 Q1\",\n            \"right_side\": {\n              \"unit\": \"fiscal_quarter\",\n              \"count\": 1\n            }\n          }\n        ]\n      },\n      \"modelId\": \"e3a78095-f13c-49a2-9a4c-617fca386ca4\",\n      \"version\": 8\n    }\n  }\n]\n```\n</expected_output>\n</complete_example>\n</examples>\n\n<input>\n{\n  \"query\": {{ $json.query.toJsonString() }},\n  \"current_fiscal_quarter\": \"{{  $('Fiscal Quarter Extractor').item.json.output.current_fiscal_quarter }}\",\n  \"previous_fiscal_quarter\": \"{{ $('Fiscal Quarter Extractor').item.json.output.previous_fiscal_quarter }}\"\n}\n</input>\n\n<edge_cases>\n<description>\nEdge Cases to Handle\n</description>\n\n<case_1>\n1. Query with existing sorts:\n- Existing sorts are **replaced entirely** with the single measure sort\n- Each query pair gets a fresh sorts array with only one sort object\n- The original sorts array is NOT preserved\n\n**Example Input:**\n```json\n{\n  \"sorts\": [\n    {\n      \"column_name\": \"sales__opportunity.new_arr_derived\",\n      \"sort_descending\": true\n    }\n  ],\n  \"fields\": [\n    \"sales__opportunity.account_name\",\n    \"sales__opportunity.new_arr_derived\",\n    \"sales__opportunity.total_arr\"\n  ]\n}\n```\n\n**Processing:**\n- Numeric measures: `new_arr_derived`, `total_arr` (2 measures)\n- Generate 2 query pairs, each with a single-element sorts array\n\n**Result:** Array with 2 query pairs\n- Query pair 1: `sorts: [{ \"column_name\": \"sales__opportunity.new_arr_derived\", ... }]`\n- Query pair 2: `sorts: [{ \"column_name\": \"sales__opportunity.total_arr\", ... }]`\n</case_1>\n\n<case_2>\n2. Query with no numeric measures:\n- Return an array with **one element** containing a query pair with empty sorts\n\n**Example Input:**\n```json\n{\n  \"fields\": [\n    \"sales__accounts.account_name\",\n    \"sales__accounts.owner_name\",\n    \"sales__opportunity.close_date\"\n  ],\n  \"sorts\": []\n}\n```\n\n**Result:**\n```json\n[\n  {\n    \"sorted_by_measure\": null,\n    \"current_fiscal_quarter_query\": {\n      \"sorts\": [],\n      /* ... rest of query with current FQ filter, limit: 200 */\n    },\n    \"previous_fiscal_quarter_query\": {\n      \"sorts\": [],\n      /* ... rest of query with previous FQ filter, limit: 200 */\n    }\n  }\n]\n```\n</case_2>\n\n<case_3>\n3. Query with single numeric measure:\n- Return an array with **one element** containing a query pair sorted by that measure\n\n**Example Input:**\n```json\n{\n  \"fields\": [\n    \"sales__accounts.account_name\",\n    \"sales__opportunity.total_arr\"\n  ]\n}\n```\n\n**Result:** Array with 1 query pair, sorted by `total_arr`\n</case_3>\n\n<case_4>\n4. Query with mixed numeric and dimension fields:\n- Only generate query pairs for true numeric measures\n- Skip all dimension fields even if they contain numbers in their values\n  </case_4>\n\n<case_5>\n5. Multiple TIME_FOR_UNIT_DURATION filters:\n- Only modify the FIRST occurrence\n- Leave other TIME_* filters unchanged\n  </case_5>\n\n<case_6>\n6. Missing TIME_FOR_UNIT_DURATION filter:\n- Return error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n  </case_6>\n\n<case_7>\n7. Malformed JSON:\n- Return error object: `{\"error\": \"Invalid JSON structure\", \"details\": \"<specific issue>\"}`\n  </case_7>\n  </edge_cases>\n\n<guidelines>\n<description>\nProcessing Guidelines\n</description>\n\n- Preserve JSON formatting exactly; do not pretty-print or minify.\n- Generate one query pair per numeric measure identified.\n- Each query pair's sorts array contains **exactly one** sort object for that measure.\n- Existing sorts in the input query are **replaced entirely** - do not append to them.\n- Do not alter any filters except the first TIME_FOR_UNIT_DURATION filter's left_side value.\n- If no matching TIME_FOR_UNIT_DURATION filter exists, return an error object: `{\"error\": \"TIME_FOR_UNIT_DURATION filter not found\"}`\n- Point out any ambiguities or missing data instead of guessing.\n- Do not simply agree with assumptions; highlight logical or data issues and propose corrections.\n- Mention tricky edge cases when they occur.\n- Output only valid JSON array or an error object - no commentary, preamble, or markdown formatting.\n- Within each query pair, both queries must have identical sorts arrays (the same single measure).\n- Set limit to exactly 200 in all output queries.\n- All queries should be complete, valid Omni query objects.\n- If no numeric measures are found, return an array with one element where `sorted_by_measure` is `null` and sorts arrays are empty.\n  </guidelines>\n\n<output_format>\n<description>\nExpected Output Structure\n\nThe output is a **JSON array** where each element represents a query pair sorted by a single numeric measure.\n</description>\n\n```json\n[\n  {\n    \"sorted_by_measure\": \"schema__table.measure_name_1\",\n    \"current_fiscal_quarter_query\": {\n      /* Complete query object with:\n         - sorts: single-element array with ONE measure sort\n         - limit: 200\n         - filters: TIME_FOR_UNIT_DURATION.left_side = current_fiscal_quarter\n         - all other fields: unchanged\n      */\n    },\n    \"previous_fiscal_quarter_query\": {\n      /* Complete query object with:\n         - sorts: single-element array with same ONE measure sort\n         - limit: 200\n         - filters: TIME_FOR_UNIT_DURATION.left_side = previous_fiscal_quarter\n         - all other fields: unchanged\n      */\n    }\n  },\n  {\n    \"sorted_by_measure\": \"schema__table.measure_name_2\",\n    \"current_fiscal_quarter_query\": { /* sorted by measure_2 */ },\n    \"previous_fiscal_quarter_query\": { /* sorted by measure_2 */ }\n  }\n  /* ... one element per numeric measure */\n]\n```\n\n<field_definitions>\nArray Element Fields:\n- **sorted_by_measure** (string | null): The full measure name this query pair is sorted by. Set to `null` if no numeric measures exist.\n- **current_fiscal_quarter_query** (object): Query with current FQ filter and limit: 200\n- **previous_fiscal_quarter_query** (object): Query with previous FQ filter and limit: 200\n</field_definitions>\n\nIf there's an error:\n```json\n{\n  \"error\": \"Error description\",\n  \"details\": \"Specific issue details\"\n}\n```\n</output_format>\n\n<validation_checklist>\n<description>\nValidation Before Returning\n\nVerify the following before returning the result:\n</description>\n\n- [ ] Output is a JSON **array** (not an object)\n- [ ] Array has N elements where N = number of numeric measures (or 1 element if no measures)\n- [ ] Each array element has all three keys: `sorted_by_measure`, `current_fiscal_quarter_query`, `previous_fiscal_quarter_query`\n- [ ] Each `sorted_by_measure` is a valid measure name string (or `null` if no measures)\n- [ ] Each query's \"sorts\" array has **exactly one** sort object (or empty array if no measures)\n- [ ] Each sort object has both \"column_name\" and \"sort_descending\" fields\n- [ ] All \"sort_descending\" values are `true`\n- [ ] Both queries in each pair have \"limit\" set to 200\n- [ ] Current query has correct current_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Previous query has correct previous_fiscal_quarter in TIME_FOR_UNIT_DURATION filter\n- [ ] Both queries in each pair have **identical** \"sorts\" arrays (same single measure)\n- [ ] No dimension fields (names, IDs, dates) appear as `sorted_by_measure`\n- [ ] All other fields (table, modelId, version, etc.) are preserved unchanged in each query\n- [ ] The output is valid JSON with no syntax errors\n  </validation_checklist>\n",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3,
        "position": [
          5152,
          1504
        ],
        "id": "a9cca20c-75ad-4dbd-ae3f-c04559bb043e",
        "name": "Query JSON Modifier"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "board-deck-takeaways-ze5ubv1w",
          "authentication": "basicAuth",
          "responseMode": "responseNode",
          "options": {
            "responseHeaders": {
              "entries": [
                {
                  "name": "Content-Type",
                  "value": "application/json"
                }
              ]
            }
          }
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          224,
          1392
        ],
        "id": "6ed5e716-a593-43f8-a2a5-ff2b55e7606a",
        "name": "Trigger",
        "webhookId": "1298ec1c-5d6c-4010-9b21-b40fada0aa39",
        "alwaysOutputData": true,
        "credentials": {
          "httpBasicAuth": {
            "id": "3AVUqEU99hkVKUOW",
            "name": "Zapier Inbound Basic Auth Webhook"
          }
        }
      },
      {
        "parameters": {
          "respondWith": "noData",
          "options": {
            "responseCode": 202
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          480,
          1392
        ],
        "id": "ee9d858a-7473-476a-8e2d-509ceb132fb6",
        "name": "Respond to Webhook"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "KNaGu0JiDRPuHSkx",
            "mode": "list",
            "cachedResultUrl": "/workflow/KNaGu0JiDRPuHSkx",
            "cachedResultName": "Board_Deck_Omni_Query_Analysis_Subworkflow"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {
              "current_fiscal_quarter_query": "={{ $json.current_fiscal_quarter_query }}",
              "previous_fiscal_quarter_query": "={{ $json.previous_fiscal_quarter_query }}",
              "document_query_id": "={{ $json.document_query_id }}",
              "document_query_name": "={{ $json.document_query_name }}",
              "drill_name": "={{ $json.drill_name }}",
              "current_fiscal_quarter": "={{ $json.current_fiscal_quarter }}",
              "previous_fiscal_quarter": "={{ $json.previous_fiscal_quarter }}",
              "current_fiscal_half": "={{ $json.current_fiscal_half }}",
              "previous_fiscal_half": "={{ $json.previous_fiscal_half }}",
              "user_id": "={{ $json.user_id }}",
              "google_document_id": "={{ $json.google_document_id }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "current_fiscal_quarter_query",
                "displayName": "current_fiscal_quarter_query",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "object",
                "removed": false
              },
              {
                "id": "previous_fiscal_quarter_query",
                "displayName": "previous_fiscal_quarter_query",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "object",
                "removed": false
              },
              {
                "id": "document_query_id",
                "displayName": "document_query_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "document_query_name",
                "displayName": "document_query_name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "drill_name",
                "displayName": "drill_name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "current_fiscal_quarter",
                "displayName": "current_fiscal_quarter",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "previous_fiscal_quarter",
                "displayName": "previous_fiscal_quarter",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "current_fiscal_half",
                "displayName": "current_fiscal_half",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "previous_fiscal_half",
                "displayName": "previous_fiscal_half",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "user_id",
                "displayName": "user_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              },
              {
                "id": "google_document_id",
                "displayName": "google_document_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "canBeUsedToMatch": true,
                "type": "string",
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {
            "waitForSubWorkflow": false
          }
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.3,
        "position": [
          6640,
          1696
        ],
        "id": "9b83e1fc-e191-413b-805b-996c7d5de321",
        "name": "Call 'Board_Deck_Omni_Query_Analysis_Subworkflow'"
      },
      {
        "parameters": {
          "resource": "folder",
          "name": "=Board_Deck_Takeaways_{{ $now.format('yyyyMMdd_HHmmss') }}",
          "driveId": {
            "__rl": true,
            "value": "My Drive",
            "mode": "list",
            "cachedResultName": "My Drive",
            "cachedResultUrl": "https://drive.google.com/drive/my-drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1dSd5PWJ0BH1ksydt-GnYJraDhwLnAbGZ",
            "mode": "list",
            "cachedResultName": "AI Workflow - Board Deck Takeaways",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1dSd5PWJ0BH1ksydt-GnYJraDhwLnAbGZ"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          1600,
          1120
        ],
        "id": "15d9460c-b80f-4f00-9421-f1073c6e8a94",
        "name": "Create folder",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "SgST8lxFUWMslYat",
            "name": "Google Drive Cribl"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": []
          },
          "includeOtherFields": true,
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          3424,
          1280
        ],
        "id": "2644febc-6619-4de2-ac6c-b17278e1c02d",
        "name": "Loop UUID Item"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": []
          },
          "includeOtherFields": true,
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          4736,
          1504
        ],
        "id": "146faf1b-dcc0-44f5-8699-57d5106857e3",
        "name": "Loop Query Item"
      },
      {
        "parameters": {
          "driveId": "0AMo0z91EPlT1Uk9PVA",
          "folderId": "=1omG14xnIzyoMcZvRqAIdiSPm4U9DFppR",
          "title": "={{ $('Loop Over UUIDs').item.json.document_query_name }}"
        },
        "type": "n8n-nodes-base.googleDocs",
        "typeVersion": 2,
        "position": [
          3744,
          1456
        ],
        "id": "e61568b1-3b9b-4c59-98c9-ba817d46fe30",
        "name": "Create Takeaways Doc Shared Drive",
        "credentials": {
          "googleDocsOAuth2Api": {
            "id": "dzy8xbOq7YSB6444",
            "name": "Google Docs Cribl"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "folderId": "={{ $('Create folder').item.json.id }}",
          "title": "={{ $json.document_query_name }}"
        },
        "type": "n8n-nodes-base.googleDocs",
        "typeVersion": 2,
        "position": [
          3744,
          1280
        ],
        "id": "6457a53e-148f-4261-8fcd-82c8662ab477",
        "name": "Create Takeaways Doc",
        "credentials": {
          "googleDocsOAuth2Api": {
            "id": "dzy8xbOq7YSB6444",
            "name": "Google Docs Cribl"
          }
        }
      },
      {
        "parameters": {
          "content": "- No matter how many drill query sort versions that a drill query has, this loop (which goes for each drill query) should only still input one takeaway per drill query"
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          5520,
          2048
        ],
        "typeVersion": 1,
        "id": "6c326fa0-6fd2-4005-ab4b-69c5de620beb",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "content": "- No matter how many drill queries (and thus drill query sort versions) that a document query has, this loop (which goes for each document query/chart) should only still create one google doc within the folder per document query",
          "height": 208
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          3456,
          1760
        ],
        "typeVersion": 1,
        "id": "8dc7f025-9cef-4f86-9278-e4d352662333",
        "name": "Sticky Note3"
      }
    ],
    "connections": {
      "When clicking 'Execute workflow'": {
        "main": [
          [
            {
              "node": "Global Vars",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Global Vars": {
        "main": [
          [
            {
              "node": "Fiscal Quarter Extractor",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Load Drill Queries": {
        "main": [
          [
            {
              "node": "Get Drill Queries Count",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over UUIDs": {
        "main": [
          [
            {
              "node": "Initialize finishedSet",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Loop UUID Item",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Queries": {
        "main": [
          [
            {
              "node": "Loop Over UUIDs",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Loop Query Item",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "POST Drill Query": {
        "main": [
          []
        ]
      },
      "Prepare UUID Loop Data": {
        "main": [
          [
            {
              "node": "Loop Over UUIDs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract Queries for UUID": {
        "main": [
          [
            {
              "node": "Loop Over Queries",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook Callback Wait": {
        "main": [
          [
            {
              "node": "Update finishedSet",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update finishedSet": {
        "main": [
          [
            {
              "node": "Acknowledge Finished",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Initialize finishedSet": {
        "main": [
          [
            {
              "node": "If All Finished",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If All Finished": {
        "main": [
          [
            {
              "node": "Continue Workflow (noop)",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Webhook Callback Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Acknowledge Finished": {
        "main": [
          [
            {
              "node": "If All Finished",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Drill Queries Count": {
        "main": [
          [
            {
              "node": "Prepare UUID Loop Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait": {
        "main": [
          [
            {
              "node": "Loop Over Queries",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Fiscal Quarter Extractor",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Fiscal Quarter Extractor": {
        "main": [
          [
            {
              "node": "Create folder",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser1": {
        "ai_outputParser": [
          []
        ]
      },
      "Parse Modified Query AI Output": {
        "main": [
          []
        ]
      },
      "o4-mini": {
        "ai_languageModel": [
          [
            {
              "node": "Fiscal Quarter Extractor",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Create Request Payload": {
        "main": [
          [
            {
              "node": "Call 'Board_Deck_Omni_Query_Analysis_Subworkflow'",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser2": {
        "ai_outputParser": [
          []
        ]
      },
      "Parse Modified Query AI Output1": {
        "main": [
          [
            {
              "node": "Create Request Payload",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OLD Query JSON Modifier": {
        "main": [
          [
            {
              "node": "Parse Modified Query AI Output",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OLD gpt-5-mini": {
        "ai_languageModel": [
          [
            {
              "node": "OLD Query JSON Modifier",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "gpt-5-mini": {
        "ai_languageModel": [
          [
            {
              "node": "Query JSON Modifier",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Query JSON Modifier": {
        "main": [
          [
            {
              "node": "Parse Modified Query AI Output1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Trigger": {
        "main": [
          [
            {
              "node": "Respond to Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Respond to Webhook": {
        "main": [
          [
            {
              "node": "Global Vars",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Call 'Board_Deck_Omni_Query_Analysis_Subworkflow'": {
        "main": [
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create folder": {
        "main": [
          [
            {
              "node": "Load Drill Queries",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop UUID Item": {
        "main": [
          [
            {
              "node": "Create Takeaways Doc",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Query Item": {
        "main": [
          [
            {
              "node": "Query JSON Modifier",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create Takeaways Doc Shared Drive": {
        "main": [
          []
        ]
      },
      "Create Takeaways Doc": {
        "main": [
          [
            {
              "node": "Extract Queries for UUID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Nathan K",
    "name": null,
    "description": null
  },
  "tags": []
}