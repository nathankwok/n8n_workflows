{
  "createdAt": "2025-07-03T18:48:16.604Z",
  "updatedAt": "2025-07-13T07:20:49.207Z",
  "id": "Qj5jkH3PTR7kcqci",
  "name": "Stock_Options_Trader_2",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9,15 * * 1-5"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1480,
        240
      ],
      "id": "f32157a7-5140-4edb-8787-859de037ffac",
      "name": "Market Hours Trigger",
      "notes": "Triggers at 9 AM and 3 PM EST on weekdays (market open/close)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "max-symbols-per-batch",
              "name": "max_symbols_per_batch",
              "value": 5,
              "type": "number"
            },
            {
              "id": "max-parallel-agents",
              "name": "max_parallel_agents",
              "value": 5,
              "type": "number"
            },
            {
              "id": "risk-tolerance",
              "name": "risk_tolerance",
              "value": 0.02,
              "type": "number"
            },
            {
              "id": "max-position-size",
              "name": "max_position_size",
              "value": 1000,
              "type": "number"
            },
            {
              "id": "target-delta",
              "name": "target_delta",
              "value": 0,
              "type": "number"
            },
            {
              "id": "global-execution-timestamp",
              "name": "execution_timestamp",
              "value": "={{ $now.format('yyyy-MM-dd HH:mm:ss') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1260,
        240
      ],
      "id": "8ebe1909-052b-4d81-b148-5b93bf6dbf08",
      "name": "Set Global Variables",
      "alwaysOutputData": true,
      "notes": "Configure workflow parameters and risk management settings"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Retrieve a dynamic list of liquid stock symbols for options analysis. Filter for symbols with high volume and options activity. Return a JSON array of 20-30 symbols suitable for delta neutral strategies. Focus on large-cap stocks with active options markets.\n\nCurrent execution timestamp: {{ $('Set Global Variables').item.json.execution_timestamp }}\nRisk tolerance: {{ $('Set Global Variables').item.json.risk_tolerance }}\nMax position size: {{ $('Set Global Variables').item.json.max_position_size }}",
        "options": {
          "systemMessage": "You are the main orchestrator for an automated stock options trading system focused on delta neutral strategies. Your primary responsibilities are:\n\n1. **Symbol Selection**: Retrieve dynamic lists of liquid stocks suitable for options trading\n2. **Coordination**: Manage the flow between analysis subagents and validation\n3. **Risk Management**: Ensure all trades align with risk tolerance parameters\n4. **Trade Execution**: Execute approved trades through broker APIs\n5. **Monitoring**: Track portfolio delta and overall performance\n\nYou have access to financial data MCP servers for symbol screening and market data. Always prioritize risk management and ensure delta neutral positioning. Only work with highly liquid stocks that have active options markets.\n\nIMPORTANT: Return symbol lists as clean JSON arrays without any markdown formatting or additional text."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -1040,
        240
      ],
      "id": "ea77406e-1696-4035-9ca7-fe9391202942",
      "name": "Orchestrator Agent",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "notes": "Main coordinator for symbol retrieval and workflow management"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol-list-parsed",
              "name": "symbols",
              "value": "={{ JSON.parse($json.output) }}",
              "type": "array"
            },
            {
              "id": "batch-size",
              "name": "batch_size",
              "value": "={{ $('Set Global Variables').item.json.max_symbols_per_batch }}",
              "type": "number"
            },
            {
              "id": "total-symbols",
              "name": "total_symbols",
              "value": "={{ JSON.parse($json.output).length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -680,
        240
      ],
      "id": "5d8370c4-3502-4104-9daa-d2db58e7dff1",
      "name": "Process Symbol List",
      "alwaysOutputData": true,
      "notes": "Parse orchestrator output and prepare for batch processing"
    },
    {
      "parameters": {
        "batchSize": "={{ $json.batch_size }}",
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -460,
        240
      ],
      "id": "6cd60582-4f82-407f-8910-854c3a0cf117",
      "name": "Split Symbol Batches",
      "executeOnce": false,
      "alwaysOutputData": true,
      "notes": "Split symbols into smaller batches for parallel processing across 5 branches"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyze options for the following symbols: {{ $json.symbols.join(', ') }}\n\nFor each symbol, perform comprehensive delta neutral options analysis:\n\n1. **Fetch Options Chain**: Get current options chain data with all strikes and expiries\n2. **Calculate Greeks**: Delta, gamma, theta, vega for all options\n3. **Implied Volatility Analysis**: Compare market IV to historical volatility\n4. **Delta Neutral Opportunities**: Identify specific strategies:\n   - Long/Short Straddles\n   - Long/Short Strangles  \n   - Iron Condors\n   - Butterfly Spreads\n5. **Risk Assessment**: Calculate profit potential, maximum loss, breakeven points\n\nReturn results as structured JSON for each symbol with the following format:\n{\n  \"symbol\": \"AAPL\",\n  \"current_price\": 150.25,\n  \"options_data\": {...},\n  \"delta_neutral_opportunities\": [\n    {\n      \"strategy\": \"long_straddle\",\n      \"strike\": 150,\n      \"expiry\": \"2025-01-17\", \n      \"delta\": 0.02,\n      \"implied_volatility\": 0.25,\n      \"profit_potential\": 0.15,\n      \"risk_score\": 0.3,\n      \"max_loss\": 500,\n      \"breakeven_upper\": 155,\n      \"breakeven_lower\": 145\n    }\n  ]\n}",
        "options": {
          "systemMessage": "You are a delta neutral options analysis specialist. Your expertise includes:\n\n**Core Competencies:**\n- Options pricing models (Black-Scholes, Binomial)\n- Greeks calculation and interpretation\n- Implied volatility analysis and forecasting\n- Delta neutral strategy construction\n- Risk management and position sizing\n\n**Analysis Framework:**\n1. **Data Retrieval**: Use MCP tools to fetch real-time options chains\n2. **Greeks Analysis**: Calculate and interpret delta, gamma, theta, vega\n3. **Strategy Identification**: Find delta neutral opportunities with attractive risk/reward\n4. **Risk Assessment**: Evaluate maximum loss, profit potential, and probability of success\n\n**Key Strategies to Focus On:**\n- **Straddles/Strangles**: Volatility plays with neutral market direction bias\n- **Iron Condors**: Range-bound strategies with limited risk\n- **Butterfly Spreads**: Low-cost, limited risk/reward strategies\n\n**Decision Criteria:**\n- Target delta: Â±0.05 (near neutral)\n- Minimum profit potential: 10%\n- Maximum risk score: 0.5\n- Preferred expiry: 30-60 days\n\nAlways return clean JSON without markdown formatting."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -240,
        -160
      ],
      "id": "88bcd1dc-9465-48a7-bf78-8e9eb2ea3929",
      "name": "Options Analysis Subagent 1",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Delta neutral options analysis for symbol batch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyze options for the following symbols: {{ $json.symbols.join(', ') }}\n\nFor each symbol, perform comprehensive delta neutral options analysis:\n\n1. **Fetch Options Chain**: Get current options chain data with all strikes and expiries\n2. **Calculate Greeks**: Delta, gamma, theta, vega for all options\n3. **Implied Volatility Analysis**: Compare market IV to historical volatility\n4. **Delta Neutral Opportunities**: Identify specific strategies:\n   - Long/Short Straddles\n   - Long/Short Strangles  \n   - Iron Condors\n   - Butterfly Spreads\n5. **Risk Assessment**: Calculate profit potential, maximum loss, breakeven points\n\nReturn results as structured JSON for each symbol with the following format:\n{\n  \"symbol\": \"AAPL\",\n  \"current_price\": 150.25,\n  \"options_data\": {...},\n  \"delta_neutral_opportunities\": [\n    {\n      \"strategy\": \"long_straddle\",\n      \"strike\": 150,\n      \"expiry\": \"2025-01-17\", \n      \"delta\": 0.02,\n      \"implied_volatility\": 0.25,\n      \"profit_potential\": 0.15,\n      \"risk_score\": 0.3,\n      \"max_loss\": 500,\n      \"breakeven_upper\": 155,\n      \"breakeven_lower\": 145\n    }\n  ]\n}",
        "options": {
          "systemMessage": "You are a delta neutral options analysis specialist. Your expertise includes:\n\n**Core Competencies:**\n- Options pricing models (Black-Scholes, Binomial)\n- Greeks calculation and interpretation\n- Implied volatility analysis and forecasting\n- Delta neutral strategy construction\n- Risk management and position sizing\n\n**Analysis Framework:**\n1. **Data Retrieval**: Use MCP tools to fetch real-time options chains\n2. **Greeks Analysis**: Calculate and interpret delta, gamma, theta, vega\n3. **Strategy Identification**: Find delta neutral opportunities with attractive risk/reward\n4. **Risk Assessment**: Evaluate maximum loss, profit potential, and probability of success\n\n**Key Strategies to Focus On:**\n- **Straddles/Strangles**: Volatility plays with neutral market direction bias\n- **Iron Condors**: Range-bound strategies with limited risk\n- **Butterfly Spreads**: Low-cost, limited risk/reward strategies\n\n**Decision Criteria:**\n- Target delta: Â±0.05 (near neutral)\n- Minimum profit potential: 10%\n- Maximum risk score: 0.5\n- Preferred expiry: 30-60 days\n\nAlways return clean JSON without markdown formatting."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -240,
        40
      ],
      "id": "57d63148-4910-45a5-9cd1-cfd048e0f468",
      "name": "Options Analysis Subagent 2",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Delta neutral options analysis for symbol batch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyze options for the following symbols: {{ $json.symbols.join(', ') }}\n\nFor each symbol, perform comprehensive delta neutral options analysis:\n\n1. **Fetch Options Chain**: Get current options chain data with all strikes and expiries\n2. **Calculate Greeks**: Delta, gamma, theta, vega for all options\n3. **Implied Volatility Analysis**: Compare market IV to historical volatility\n4. **Delta Neutral Opportunities**: Identify specific strategies:\n   - Long/Short Straddles\n   - Long/Short Strangles  \n   - Iron Condors\n   - Butterfly Spreads\n5. **Risk Assessment**: Calculate profit potential, maximum loss, breakeven points\n\nReturn results as structured JSON for each symbol with the following format:\n{\n  \"symbol\": \"AAPL\",\n  \"current_price\": 150.25,\n  \"options_data\": {...},\n  \"delta_neutral_opportunities\": [\n    {\n      \"strategy\": \"long_straddle\",\n      \"strike\": 150,\n      \"expiry\": \"2025-01-17\", \n      \"delta\": 0.02,\n      \"implied_volatility\": 0.25,\n      \"profit_potential\": 0.15,\n      \"risk_score\": 0.3,\n      \"max_loss\": 500,\n      \"breakeven_upper\": 155,\n      \"breakeven_lower\": 145\n    }\n  ]\n}",
        "options": {
          "systemMessage": "You are a delta neutral options analysis specialist. Your expertise includes:\n\n**Core Competencies:**\n- Options pricing models (Black-Scholes, Binomial)\n- Greeks calculation and interpretation\n- Implied volatility analysis and forecasting\n- Delta neutral strategy construction\n- Risk management and position sizing\n\n**Analysis Framework:**\n1. **Data Retrieval**: Use MCP tools to fetch real-time options chains\n2. **Greeks Analysis**: Calculate and interpret delta, gamma, theta, vega\n3. **Strategy Identification**: Find delta neutral opportunities with attractive risk/reward\n4. **Risk Assessment**: Evaluate maximum loss, profit potential, and probability of success\n\n**Key Strategies to Focus On:**\n- **Straddles/Strangles**: Volatility plays with neutral market direction bias\n- **Iron Condors**: Range-bound strategies with limited risk\n- **Butterfly Spreads**: Low-cost, limited risk/reward strategies\n\n**Decision Criteria:**\n- Target delta: Â±0.05 (near neutral)\n- Minimum profit potential: 10%\n- Maximum risk score: 0.5\n- Preferred expiry: 30-60 days\n\nAlways return clean JSON without markdown formatting."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -240,
        240
      ],
      "id": "d72a0ad2-27d1-47db-8603-347ec16345f7",
      "name": "Options Analysis Subagent 3",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Delta neutral options analysis for symbol batch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyze options for the following symbols: {{ $json.symbols.join(', ') }}\n\nFor each symbol, perform comprehensive delta neutral options analysis:\n\n1. **Fetch Options Chain**: Get current options chain data with all strikes and expiries\n2. **Calculate Greeks**: Delta, gamma, theta, vega for all options\n3. **Implied Volatility Analysis**: Compare market IV to historical volatility\n4. **Delta Neutral Opportunities**: Identify specific strategies:\n   - Long/Short Straddles\n   - Long/Short Strangles  \n   - Iron Condors\n   - Butterfly Spreads\n5. **Risk Assessment**: Calculate profit potential, maximum loss, breakeven points\n\nReturn results as structured JSON for each symbol with the following format:\n{\n  \"symbol\": \"AAPL\",\n  \"current_price\": 150.25,\n  \"options_data\": {...},\n  \"delta_neutral_opportunities\": [\n    {\n      \"strategy\": \"long_straddle\",\n      \"strike\": 150,\n      \"expiry\": \"2025-01-17\", \n      \"delta\": 0.02,\n      \"implied_volatility\": 0.25,\n      \"profit_potential\": 0.15,\n      \"risk_score\": 0.3,\n      \"max_loss\": 500,\n      \"breakeven_upper\": 155,\n      \"breakeven_lower\": 145\n    }\n  ]\n}",
        "options": {
          "systemMessage": "You are a delta neutral options analysis specialist. Your expertise includes:\n\n**Core Competencies:**\n- Options pricing models (Black-Scholes, Binomial)\n- Greeks calculation and interpretation\n- Implied volatility analysis and forecasting\n- Delta neutral strategy construction\n- Risk management and position sizing\n\n**Analysis Framework:**\n1. **Data Retrieval**: Use MCP tools to fetch real-time options chains\n2. **Greeks Analysis**: Calculate and interpret delta, gamma, theta, vega\n3. **Strategy Identification**: Find delta neutral opportunities with attractive risk/reward\n4. **Risk Assessment**: Evaluate maximum loss, profit potential, and probability of success\n\n**Key Strategies to Focus On:**\n- **Straddles/Strangles**: Volatility plays with neutral market direction bias\n- **Iron Condors**: Range-bound strategies with limited risk\n- **Butterfly Spreads**: Low-cost, limited risk/reward strategies\n\n**Decision Criteria:**\n- Target delta: Â±0.05 (near neutral)\n- Minimum profit potential: 10%\n- Maximum risk score: 0.5\n- Preferred expiry: 30-60 days\n\nAlways return clean JSON without markdown formatting."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -240,
        440
      ],
      "id": "115ffdca-bde1-4ef5-a683-d8c965c05dd2",
      "name": "Options Analysis Subagent 4",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Delta neutral options analysis for symbol batch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyze options for the following symbols: {{ $json.symbols.join(', ') }}\n\nFor each symbol, perform comprehensive delta neutral options analysis:\n\n1. **Fetch Options Chain**: Get current options chain data with all strikes and expiries\n2. **Calculate Greeks**: Delta, gamma, theta, vega for all options\n3. **Implied Volatility Analysis**: Compare market IV to historical volatility\n4. **Delta Neutral Opportunities**: Identify specific strategies:\n   - Long/Short Straddles\n   - Long/Short Strangles  \n   - Iron Condors\n   - Butterfly Spreads\n5. **Risk Assessment**: Calculate profit potential, maximum loss, breakeven points\n\nReturn results as structured JSON for each symbol with the following format:\n{\n  \"symbol\": \"AAPL\",\n  \"current_price\": 150.25,\n  \"options_data\": {...},\n  \"delta_neutral_opportunities\": [\n    {\n      \"strategy\": \"long_straddle\",\n      \"strike\": 150,\n      \"expiry\": \"2025-01-17\", \n      \"delta\": 0.02,\n      \"implied_volatility\": 0.25,\n      \"profit_potential\": 0.15,\n      \"risk_score\": 0.3,\n      \"max_loss\": 500,\n      \"breakeven_upper\": 155,\n      \"breakeven_lower\": 145\n    }\n  ]\n}",
        "options": {
          "systemMessage": "You are a delta neutral options analysis specialist. Your expertise includes:\n\n**Core Competencies:**\n- Options pricing models (Black-Scholes, Binomial)\n- Greeks calculation and interpretation\n- Implied volatility analysis and forecasting\n- Delta neutral strategy construction\n- Risk management and position sizing\n\n**Analysis Framework:**\n1. **Data Retrieval**: Use MCP tools to fetch real-time options chains\n2. **Greeks Analysis**: Calculate and interpret delta, gamma, theta, vega\n3. **Strategy Identification**: Find delta neutral opportunities with attractive risk/reward\n4. **Risk Assessment**: Evaluate maximum loss, profit potential, and probability of success\n\n**Key Strategies to Focus On:**\n- **Straddles/Strangles**: Volatility plays with neutral market direction bias\n- **Iron Condors**: Range-bound strategies with limited risk\n- **Butterfly Spreads**: Low-cost, limited risk/reward strategies\n\n**Decision Criteria:**\n- Target delta: Â±0.05 (near neutral)\n- Minimum profit potential: 10%\n- Maximum risk score: 0.5\n- Preferred expiry: 30-60 days\n\nAlways return clean JSON without markdown formatting."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -240,
        640
      ],
      "id": "adf60a30-bab5-4d24-93c7-34f228404ae4",
      "name": "Options Analysis Subagent 5",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Delta neutral options analysis for symbol batch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Perform preliminary risk assessment on the following analysis results:\n\n{{ JSON.stringify($json) }}\n\n**Quick Validation Criteria:**\n1. Delta neutrality check (Â±0.05)\n2. Risk score validation (â¤0.5)\n3. Minimum profit potential (â¥10%)\n4. Liquidity verification\n5. Position size compliance\n\nFilter out high-risk or non-compliant opportunities. Only pass validated opportunities to the merge step.\n\nReturn format:\n{\n  \"validated_opportunities\": [...],\n  \"rejected_count\": 0,\n  \"branch_risk_score\": 0.0,\n  \"validation_summary\": \"Brief summary of validation results\"\n}",
        "options": {
          "systemMessage": "You are a branch-level risk validator for options trading opportunities. Your role is to perform quick, preliminary risk assessment to filter out non-compliant opportunities before they reach the portfolio-level validation.\n\n**Focus Areas:**\n- Delta neutrality validation (Â±0.05)\n- Risk score assessment (â¤0.5)\n- Profit potential verification (â¥10%)\n- Basic compliance checks\n- Liquidity requirements\n\n**Decision Framework:**\n- PASS: Opportunities that meet all basic criteria\n- FILTER: Remove opportunities that fail any validation check\n- CONDITIONAL: Flag borderline cases for portfolio-level review\n\n**Key Responsibilities:**\n- Quick preliminary filtering\n- Risk score calculation\n- Compliance verification\n- Efficient processing for merge step\n\nBe efficient but thorough. Focus on clear pass/fail criteria rather than complex analysis."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        120,
        -160
      ],
      "id": "56062a5a-e46b-4669-977f-eccd847442a0",
      "name": "Risk Validator Subagent 1",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Branch-level risk validation for analysis subagent 1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Perform preliminary risk assessment on the following analysis results:\n\n{{ JSON.stringify($json) }}\n\n**Quick Validation Criteria:**\n1. Delta neutrality check (Â±0.05)\n2. Risk score validation (â¤0.5)\n3. Minimum profit potential (â¥10%)\n4. Liquidity verification\n5. Position size compliance\n\nFilter out high-risk or non-compliant opportunities. Only pass validated opportunities to the merge step.\n\nReturn format:\n{\n  \"validated_opportunities\": [...],\n  \"rejected_count\": 0,\n  \"branch_risk_score\": 0.0,\n  \"validation_summary\": \"Brief summary of validation results\"\n}",
        "options": {
          "systemMessage": "You are a branch-level risk validator for options trading opportunities. Your role is to perform quick, preliminary risk assessment to filter out non-compliant opportunities before they reach the portfolio-level validation.\n\n**Focus Areas:**\n- Delta neutrality validation (Â±0.05)\n- Risk score assessment (â¤0.5)\n- Profit potential verification (â¥10%)\n- Basic compliance checks\n- Liquidity requirements\n\n**Decision Framework:**\n- PASS: Opportunities that meet all basic criteria\n- FILTER: Remove opportunities that fail any validation check\n- CONDITIONAL: Flag borderline cases for portfolio-level review\n\n**Key Responsibilities:**\n- Quick preliminary filtering\n- Risk score calculation\n- Compliance verification\n- Efficient processing for merge step\n\nBe efficient but thorough. Focus on clear pass/fail criteria rather than complex analysis."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        120,
        40
      ],
      "id": "892168fe-330e-4d89-858b-ececfd4e2f35",
      "name": "Risk Validator Subagent 2",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Branch-level risk validation for analysis subagent 2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Perform preliminary risk assessment on the following analysis results:\n\n{{ JSON.stringify($json) }}\n\n**Quick Validation Criteria:**\n1. Delta neutrality check (Â±0.05)\n2. Risk score validation (â¤0.5)\n3. Minimum profit potential (â¥10%)\n4. Liquidity verification\n5. Position size compliance\n\nFilter out high-risk or non-compliant opportunities. Only pass validated opportunities to the merge step.\n\nReturn format:\n{\n  \"validated_opportunities\": [...],\n  \"rejected_count\": 0,\n  \"branch_risk_score\": 0.0,\n  \"validation_summary\": \"Brief summary of validation results\"\n}",
        "options": {
          "systemMessage": "You are a branch-level risk validator for options trading opportunities. Your role is to perform quick, preliminary risk assessment to filter out non-compliant opportunities before they reach the portfolio-level validation.\n\n**Focus Areas:**\n- Delta neutrality validation (Â±0.05)\n- Risk score assessment (â¤0.5)\n- Profit potential verification (â¥10%)\n- Basic compliance checks\n- Liquidity requirements\n\n**Decision Framework:**\n- PASS: Opportunities that meet all basic criteria\n- FILTER: Remove opportunities that fail any validation check\n- CONDITIONAL: Flag borderline cases for portfolio-level review\n\n**Key Responsibilities:**\n- Quick preliminary filtering\n- Risk score calculation\n- Compliance verification\n- Efficient processing for merge step\n\nBe efficient but thorough. Focus on clear pass/fail criteria rather than complex analysis."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        120,
        240
      ],
      "id": "38ad792e-59c8-4b26-bd06-f3f49c8b188b",
      "name": "Risk Validator Subagent 3",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Branch-level risk validation for analysis subagent 3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Perform preliminary risk assessment on the following analysis results:\n\n{{ JSON.stringify($json) }}\n\n**Quick Validation Criteria:**\n1. Delta neutrality check (Â±0.05)\n2. Risk score validation (â¤0.5)\n3. Minimum profit potential (â¥10%)\n4. Liquidity verification\n5. Position size compliance\n\nFilter out high-risk or non-compliant opportunities. Only pass validated opportunities to the merge step.\n\nReturn format:\n{\n  \"validated_opportunities\": [...],\n  \"rejected_count\": 0,\n  \"branch_risk_score\": 0.0,\n  \"validation_summary\": \"Brief summary of validation results\"\n}",
        "options": {
          "systemMessage": "You are a branch-level risk validator for options trading opportunities. Your role is to perform quick, preliminary risk assessment to filter out non-compliant opportunities before they reach the portfolio-level validation.\n\n**Focus Areas:**\n- Delta neutrality validation (Â±0.05)\n- Risk score assessment (â¤0.5)\n- Profit potential verification (â¥10%)\n- Basic compliance checks\n- Liquidity requirements\n\n**Decision Framework:**\n- PASS: Opportunities that meet all basic criteria\n- FILTER: Remove opportunities that fail any validation check\n- CONDITIONAL: Flag borderline cases for portfolio-level review\n\n**Key Responsibilities:**\n- Quick preliminary filtering\n- Risk score calculation\n- Compliance verification\n- Efficient processing for merge step\n\nBe efficient but thorough. Focus on clear pass/fail criteria rather than complex analysis."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        120,
        440
      ],
      "id": "790723e7-024f-4dcd-baf9-a5467ccf6ee3",
      "name": "Risk Validator Subagent 4",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Branch-level risk validation for analysis subagent 4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Perform preliminary risk assessment on the following analysis results:\n\n{{ JSON.stringify($json) }}\n\n**Quick Validation Criteria:**\n1. Delta neutrality check (Â±0.05)\n2. Risk score validation (â¤0.5)\n3. Minimum profit potential (â¥10%)\n4. Liquidity verification\n5. Position size compliance\n\nFilter out high-risk or non-compliant opportunities. Only pass validated opportunities to the merge step.\n\nReturn format:\n{\n  \"validated_opportunities\": [...],\n  \"rejected_count\": 0,\n  \"branch_risk_score\": 0.0,\n  \"validation_summary\": \"Brief summary of validation results\"\n}",
        "options": {
          "systemMessage": "You are a branch-level risk validator for options trading opportunities. Your role is to perform quick, preliminary risk assessment to filter out non-compliant opportunities before they reach the portfolio-level validation.\n\n**Focus Areas:**\n- Delta neutrality validation (Â±0.05)\n- Risk score assessment (â¤0.5)\n- Profit potential verification (â¥10%)\n- Basic compliance checks\n- Liquidity requirements\n\n**Decision Framework:**\n- PASS: Opportunities that meet all basic criteria\n- FILTER: Remove opportunities that fail any validation check\n- CONDITIONAL: Flag borderline cases for portfolio-level review\n\n**Key Responsibilities:**\n- Quick preliminary filtering\n- Risk score calculation\n- Compliance verification\n- Efficient processing for merge step\n\nBe efficient but thorough. Focus on clear pass/fail criteria rather than complex analysis."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        120,
        640
      ],
      "id": "df9f7577-7209-4c15-b431-34ba76ffd517",
      "name": "Risk Validator Subagent 5",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "continueOnFail": true,
      "notes": "Branch-level risk validation for analysis subagent 5"
    },
    {
      "parameters": {
        "numberInputs": 5
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        480,
        200
      ],
      "id": "3dcb2935-6455-40c5-993e-8410c0f5c66a",
      "name": "Merge Analysis Results",
      "alwaysOutputData": true,
      "notes": "Combine validated results from all 5 risk validator subagents"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Perform comprehensive risk assessment and validation of the following pre-filtered delta neutral opportunities:\n\n{{ JSON.stringify($input.all()) }}\n\n**Portfolio-Level Risk Assessment:**\n\n1. **Portfolio Delta Analysis**\n   - Calculate combined portfolio delta\n   - Ensure overall position remains near neutral (Â±0.05)\n   - Assess delta sensitivity to market movements\n\n2. **Position Sizing Validation**\n   - Check individual position sizes against limits\n   - Verify maximum position size: {{ $('Set Global Variables').item.json.max_position_size }}\n   - Ensure proper diversification across symbols\n\n3. **Risk Scoring**\n   - Evaluate maximum loss potential\n   - Assess probability of profit\n   - Check risk/reward ratios\n   - Maximum acceptable risk score: 0.5\n\n4. **Market Conditions Check**\n   - Verify market hours and liquidity\n   - Check for upcoming earnings or events\n   - Assess overall market volatility\n\n**Final Approval Criteria:**\n- Minimum profit potential: 10%\n- Maximum portfolio delta: Â±0.05\n- Risk score â¤ 0.5\n- Adequate liquidity and volume\n- Position size within limits\n- Proper diversification\n\nReturn a JSON object with:\n```json\n{\n  \"approved_opportunities\": [...],\n  \"rejected_opportunities\": [...],\n  \"risk_assessment\": {\n    \"portfolio_delta\": 0.01,\n    \"total_capital_required\": 5000,\n    \"max_loss_potential\": 1000,\n    \"diversification_score\": 0.8,\n    \"overall_risk_score\": 0.3\n  },\n  \"recommendations\": \"...\"\n}\n```",
        "options": {
          "systemMessage": "You are a senior risk assessment specialist for options trading with expertise in portfolio-level risk management. Your role is the final validation layer for pre-filtered opportunities from branch-level validators.\n\n**Risk Management:**\n- Portfolio delta calculation and hedging\n- Position sizing and capital allocation\n- Stress testing and scenario analysis\n- Regulatory compliance and risk limits\n\n**Validation Framework:**\n1. **Portfolio Analysis**: Assess combined impact of all opportunities\n2. **Risk Aggregation**: Calculate total portfolio risk metrics\n3. **Correlation Analysis**: Check for concentration risks\n4. **Final Approval**: Make go/no-go decisions for trading\n\n**Key Responsibilities:**\n- Final approve/reject decisions for trading opportunities\n- Calculate portfolio-level risk metrics\n- Ensure proper diversification and position sizing\n- Monitor for correlation and concentration risks\n- Maintain delta neutral positioning\n\n**Decision Framework:**\n- APPROVE: Low risk, high probability opportunities with good risk/reward\n- CONDITIONAL: Opportunities requiring position size adjustment\n- REJECT: High risk, poor risk/reward, or limit violations\n\nAlways prioritize capital preservation while seeking attractive risk-adjusted returns."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        700,
        240
      ],
      "id": "6257197b-4160-47f3-8c48-999b4ad289ba",
      "name": "Final Risk Validator Agent",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 2,
      "notes": "Portfolio-level risk assessment and final opportunity validation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "approved-opportunities-exist",
              "leftValue": "={{ JSON.parse($json.output).approved_opportunities.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1060,
        240
      ],
      "id": "4b761a52-1334-4a93-ab92-d88ffb2799a6",
      "name": "Check Approved Opportunities",
      "alwaysOutputData": false,
      "notes": "Only proceed if there are approved trading opportunities"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Execute the following approved delta neutral trading opportunities:\n\n{{ JSON.stringify(JSON.parse($('Final Risk Validator Agent').item.json.output).approved_opportunities) }}\n\n**Execution Requirements:**\n\n1. **Pre-Trade Validation**\n   - Verify market hours (9:30 AM - 4:00 PM EST)\n   - Check account balance and buying power\n   - Confirm option chain availability and pricing\n   - Validate position limits\n\n2. **Order Management**\n   - Place orders in logical sequence for multi-leg strategies\n   - Use limit orders with appropriate pricing\n   - Monitor fill status and adjust if needed\n   - Implement proper timing for simultaneous execution\n\n3. **Risk Controls**\n   - Verify final delta neutrality before execution\n   - Double-check position sizing\n   - Confirm stop-loss and profit targets\n   - Monitor margin requirements\n\n4. **Execution Monitoring**\n   - Track order fills in real-time\n   - Calculate actual delta after execution\n   - Log all trade details\n   - Update portfolio positions\n\n**Broker Integration:**\n- Use appropriate broker MCP (Alpaca, TastyTrade, Interactive Brokers)\n- Handle partial fills gracefully\n- Implement proper error handling\n- Maintain audit trail\n\nReturn execution results as:\n```json\n{\n  \"executed_trades\": [...],\n  \"failed_trades\": [...],\n  \"portfolio_delta\": 0.01,\n  \"total_capital_used\": 5000,\n  \"execution_summary\": \"...\"\n}\n```",
        "options": {
          "systemMessage": "You are a professional options trade execution specialist with expertise in:\n\n**Trade Execution:**\n- Multi-leg options strategies (straddles, strangles, spreads)\n- Market timing and order management\n- Real-time risk monitoring\n- Broker API integration\n\n**Risk Management:**\n- Delta hedging and portfolio balancing\n- Position sizing and margin calculations\n- Stop-loss and profit target implementation\n- Emergency position unwinding\n\n**Technical Integration:**\n- Broker MCP server communication\n- Order routing and execution algorithms\n- Real-time market data processing\n- Portfolio management systems\n\n**Execution Priorities:**\n1. **Safety First**: Never exceed risk limits or position sizes\n2. **Delta Neutral**: Maintain portfolio delta near zero\n3. **Efficient Execution**: Minimize slippage and timing risk\n4. **Complete Documentation**: Log all trades and decisions\n\n**Error Handling:**\n- Gracefully handle broker connection issues\n- Implement fallback execution methods\n- Alert on critical failures\n- Maintain position integrity\n\nOnly execute trades that meet all validation criteria. When in doubt, preserve capital and alert for manual review."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1280,
        140
      ],
      "id": "ec0807e2-5cf7-4dc4-b58c-374df30e4a03",
      "name": "Trade Execution Agent",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 1,
      "continueOnFail": true,
      "notes": "Execute approved trades through broker APIs"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "execution-timestamp",
              "name": "execution_timestamp",
              "value": "={{ $now.format('yyyy-MM-dd HH:mm:ss') }}",
              "type": "string"
            },
            {
              "id": "workflow-status",
              "name": "workflow_status",
              "value": "={{ $('Trade Execution Agent').item ? 'completed_with_trades' : 'completed_no_trades' }}",
              "type": "string"
            },
            {
              "id": "total-symbols-processed",
              "name": "total_symbols_processed",
              "value": "={{ $('Process Symbol List').item.json.total_symbols }}",
              "type": "number"
            },
            {
              "id": "approved-opportunities",
              "name": "approved_opportunities_count",
              "value": "={{ JSON.parse($('Final Risk Validator Agent').item.json.output).approved_opportunities.length }}",
              "type": "number"
            },
            {
              "id": "execution-summary",
              "name": "execution_summary",
              "value": "={{ $('Trade Execution Agent').item ? JSON.parse($('Trade Execution Agent').item.json.output).execution_summary : 'No trades executed - no approved opportunities' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1640,
        140
      ],
      "id": "ba2de98d-75dd-49e9-b4a1-1d963bc75d2e",
      "name": "Execution Logger",
      "alwaysOutputData": true,
      "notes": "Log workflow execution results and performance metrics"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "no-opportunities-timestamp",
              "name": "execution_timestamp",
              "value": "={{ $now.format('yyyy-MM-dd HH:mm:ss') }}",
              "type": "string"
            },
            {
              "id": "no-opportunities-status",
              "name": "workflow_status",
              "value": "completed_no_opportunities",
              "type": "string"
            },
            {
              "id": "no-opportunities-symbols",
              "name": "total_symbols_processed",
              "value": "={{ $('Process Symbol List').item.json.total_symbols }}",
              "type": "number"
            },
            {
              "id": "no-opportunities-message",
              "name": "execution_summary",
              "value": "No delta neutral opportunities met risk criteria after two-tier validation",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1350,
        340
      ],
      "id": "b3b95c4e-a34f-4502-81ec-faa17feaf8f6",
      "name": "No Opportunities Logger",
      "alwaysOutputData": true,
      "notes": "Log when no trading opportunities pass validation"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1100,
        480
      ],
      "id": "7db4947d-0891-4bc6-9374-9c84c14a766e",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "yw1nLb6Dxz18ENh2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $now.format('yyyy-MM-dd-HH:mm:ss') }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -960,
        500
      ],
      "id": "edd62a85-392b-465c-a84f-1e9f68a967b8",
      "name": "Simple Memory"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-mcp.mcpClient",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "7f58bc71-d4af-4123-9c1f-9b56146d43b8",
      "name": "MCP Client",
      "credentials": {
        "mcpClientApi": {
          "id": "5WP0c0jqCHb5LMfO",
          "name": "n8n-mcp MCP Client"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-mcp.mcpClientTool",
      "typeVersion": 1,
      "position": [
        -800,
        500
      ],
      "id": "7c6b844e-076f-4703-a196-bfb0ba73d769",
      "name": "context7 List Tools",
      "credentials": {
        "mcpClientApi": {
          "id": "M6ypncUh4MKAMkeD",
          "name": "context7 MCP Client"
        }
      }
    }
  ],
  "connections": {
    "Market Hours Trigger": {
      "main": [
        [
          {
            "node": "Set Global Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Global Variables": {
      "main": [
        [
          {
            "node": "Orchestrator Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Orchestrator Agent": {
      "main": [
        [
          {
            "node": "Process Symbol List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Symbol List": {
      "main": [
        [
          {
            "node": "Split Symbol Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Symbol Batches": {
      "main": [
        [
          {
            "node": "Options Analysis Subagent 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Options Analysis Subagent 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Options Analysis Subagent 3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Options Analysis Subagent 4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Options Analysis Subagent 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Options Analysis Subagent 1": {
      "main": [
        [
          {
            "node": "Risk Validator Subagent 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Options Analysis Subagent 2": {
      "main": [
        [
          {
            "node": "Risk Validator Subagent 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Options Analysis Subagent 3": {
      "main": [
        [
          {
            "node": "Risk Validator Subagent 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Options Analysis Subagent 4": {
      "main": [
        [
          {
            "node": "Risk Validator Subagent 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Options Analysis Subagent 5": {
      "main": [
        [
          {
            "node": "Risk Validator Subagent 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Risk Validator Subagent 1": {
      "main": [
        [
          {
            "node": "Merge Analysis Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Risk Validator Subagent 2": {
      "main": [
        [
          {
            "node": "Merge Analysis Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Analysis Results": {
      "main": [
        [
          {
            "node": "Final Risk Validator Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final Risk Validator Agent": {
      "main": [
        [
          {
            "node": "Check Approved Opportunities",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Approved Opportunities": {
      "main": [
        [
          {
            "node": "Trade Execution Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Opportunities Logger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trade Execution Agent": {
      "main": [
        [
          {
            "node": "Execution Logger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Risk Validator Subagent 3": {
      "main": [
        [
          {
            "node": "Merge Analysis Results",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Risk Validator Subagent 4": {
      "main": [
        [
          {
            "node": "Merge Analysis Results",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Risk Validator Subagent 5": {
      "main": [
        [
          {
            "node": "Merge Analysis Results",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Orchestrator Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Orchestrator Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "context7 List Tools": {
      "ai_tool": [
        [
          {
            "node": "Orchestrator Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "5d6fa688-5b2a-412a-abe7-5ae21234b5fc",
  "triggerCount": 0,
  "tags": []
}

